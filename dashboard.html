<!doctype html><meta charset="utf-8">
<title>Modbus Mirror Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;margin:0;background:#0b1220;color:#e8eefc}
  header{padding:12px 16px;border-bottom:1px solid #223;font-weight:600;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .hdr-right{display:flex;align-items:center;gap:8px}
  select.lang{background:#0f1830;border:1px solid #223;color:#9fc3ff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .icon-btn{cursor:pointer;border:1px solid #223;background:#0f1830;color:#9fc3ff;border-radius:10px;padding:6px 10px}
  .icon-btn:hover{background:#13213d}

  main{padding:16px;display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:#111a2b;border:1px solid #223;border-radius:14px;padding:14px}
  .k{font-size:12px;color:#88a;text-transform:uppercase;letter-spacing:.1em}
  .v{font-size:28px;margin-top:6px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:6px 8px;border-bottom:1px solid #223;text-align:left}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{font-size:12px;color:#88a;padding:2px 8px;border:1px solid #223;border-radius:999px}
  a{color:#9fc3ff}
  .toast{position:fixed;bottom:16px;right:16px;background:#11213a;border:1px solid #2a3b66;padding:10px 12px;border-radius:10px;display:none;z-index:1200}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#0f1830;border:1px solid #223;border-radius:14px;width:min(820px,92vw);max-height:86vh;overflow:auto}
  .modal header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #223;padding:12px 16px}
  .modal .content{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  label{font-size:12px;color:#9ab}
  input,select{width:100%;padding:8px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
  .hint{font-size:12px;color:#8aa}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #223;background:#111a2b;color:#e8eefc;cursor:pointer}
  .btn.primary{background:#2956cc}

  .topbar{background:#bcd5e8;color:#073b5a}
  .topbar-inner{max-width:1400px;margin:0 auto;padding:8px 12px;display:grid;align-items:center;gap:8px;grid-template-columns:1fr auto auto}
  .top-left{display:flex;flex-direction:column;gap:6px;font-weight:600}
  .top-left a{color:#0a4f79;text-decoration:none}
  .top-center{display:flex;align-items:center;gap:12px}
  .qr{width:96px;height:96px;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .qr img{width:96px;height:96px;display:block}
  .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .logo{height:36px;object-fit:contain}
  .yt{color:#0a4f79;text-decoration:none;font-weight:700}
  .model-line{background:#a7c8de;font-weight:700;margin-top:6px;padding:6px 10px;border-radius:6px}
  .model-line span{color:#062e46}

  .top-row{grid-column:1/-1;display:grid;grid-template-columns:repeat(3,minmax(280px,1fr));gap:16px}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px 12px;align-items:center}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .pill2{padding:2px 8px;border-radius:999px;font-size:.85rem;display:inline-block;border:1px solid #223}
  .pill2.green{background:#10331a;color:#41d888}
  .pill2.red{background:#331314;color:#ff6b6b}
  .pill2.orange{background:#332610;color:#ffb454}
  .pill2.black{background:#1a1f2d;color:#e8eefc}

  .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1220,#0d1a33);display:flex;align-items:center;justify-content:center;z-index:2000}
  .gate-card{background:#0f1830;border:1px solid #223;border-radius:16px;padding:20px;width:min(420px,92vw);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .gate-title{font-size:18px;font-weight:700;margin-bottom:8px}
  .gate-sub{color:#9ab;font-size:13px;margin-bottom:12px}
  .gate-row{display:flex;gap:8px;align-items:center}
  .gate-input{flex:1;padding:10px;border-radius:10px;border:1px solid #294;outline:none;background:#0b1220;color:#e8eefc;font-size:16px}
  .gate-btn{padding:10px 14px;border-radius:10px;border:1px solid #223;background:#2956cc;color:#fff;cursor:pointer}
  .gate-err{color:#ff6b6b;font-size:13px;margin-top:8px;min-height:18px}

  .pinbox{background:#0f1830;border:1px solid #223;border-radius:16px;padding:16px;width:min(360px,92vw)}
  .pin-title{font-weight:700;margin-bottom:6px}
  .pin-row{display:flex;gap:8px}
  .pin-input{flex:1;padding:10px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
  .pin-err{color:#ff6b6b;font-size:13px;margin-top:6px;min-height:18px}

  @media (max-width:1100px){ .top-row{grid-template-columns:1fr;}}
  @media (max-width: 640px){
    .topbar-inner{grid-template-columns:1fr;gap:12px}
    .top-right{align-items:flex-start}
  }
</style>

<!-- ====== Full-screen PIN Gate ====== -->
<div id="gate" class="gate" style="display:none">
  <div class="gate-card">
    <div id="i.gateTitle" class="gate-title">Ingrese PIN de Acceso</div>
    <div id="i.gateSub" class="gate-sub">Por favor ingrese el PIN de 4 d√≠gitos para ver el panel.</div>
    <div class="gate-row">
      <input id="gatePin" class="gate-input" type="password" placeholder="PIN" maxlength="8" inputmode="numeric" autofocus>
      <button id="gateBtn" class="gate-btn">Entrar</button>
    </div>
    <div id="gateErr" class="gate-err"></div>
  </div>
</div>

<!-- ====== Top company strip ====== -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="top-left">
      <div>üìû <a id="phoneLink" href="#">011-4639-8310</a></div>
      <div>‚úâÔ∏è <a id="emailLink" href="#">info@adaxtecna.com</a></div>
    </div>
    <div class="top-center">
      <div class="qr"><img id="qrImg" alt="QR"></div>
    </div>
    <div class="top-right">
      <img id="logoImg" class="logo" alt="Logo" src="/static/adax_logo.png"/>
      <a id="ytLink" class="yt" href="#" target="_blank">Visite nuestro canal de YouTube</a>
      <div class="model-line">
        <span id="modelLine">RECTIFICADOR ADAX TECNA MODELO: CEA ‚Äî N¬∞ SERIE: ‚Äî</span>
      </div>
    </div>
  </div>
</div>

<header>
  <div id="i.appTitle">Modbus Mirror ‚Ä¢ Panel en Vivo</div>
  <div class="hdr-right">
    <select id="langSel" class="lang" aria-label="Language">
      <option value="es">Espa√±ol</option>
      <option value="en">English</option>
    </select>
    <button id="btnSettings" class="icon-btn" title="Settings">‚öôÔ∏è <span id="i.settingsBtn">Ajustes</span></button>
  </div>
</header>

<main>
  <!-- ====== Top cards row ====== -->
  <section class="top-row">
    <!-- Measurements -->
    <div class="card" id="cardMeas">
      <div id="i.measTitle" class="k" style="letter-spacing:.08em">MEDICIONES ACTUALES</div>
      <div class="kv mono" id="measGrid" style="margin-top:8px"></div>
    </div>

    <!-- Alarms -->
    <div class="card" id="cardAlarms">
      <div id="i.alarmTitle" class="k" style="letter-spacing:.08em">ALARMAS</div>
      <div id="alarmsList" style="margin-top:8px"></div>
    </div>

    <!-- Operating state -->
    <div class="card" id="cardStates">
      <div id="i.stateTitle" class="k" style="letter-spacing:.08em">ESTADO OPERATIVO</div>
      <div id="statesList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Status / quick links -->
  <section class="card" style="grid-column:1/-1">
    <div class="row">
      <div class="pill" id="m">modo: --</div>
      <div class="pill" id="t">√∫ltimo: --</div>
      <div class="pill"><a href="/api/hr" target="_blank">/api/hr</a></div>
      <div class="pill"><a href="/api/debug_store" target="_blank">/api/debug_store</a></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px">
      <div class="card"><div id="i.tileVB" class="k">Tensi√≥n Bater√≠a</div><div class="v" id="vb">--</div></div>
      <div class="card"><div id="i.tileVL" class="k">Tensi√≥n Consumo</div><div class="v" id="vl">--</div></div>
      <div class="card"><div id="i.tileIB" class="k">Corriente Bater√≠a</div><div class="v" id="ib">--</div></div>
      <div class="card"><div id="i.tileIL" class="k">Corriente Consumo</div><div class="v" id="il">--</div></div>
      <div class="card"><div id="i.tileIT" class="k">Corriente Total</div><div class="v" id="it">--</div></div>
      <div class="card"><div id="i.tileTA" class="k">Temperatura Ambiente</div><div class="v" id="ta">--</div></div>
    </div>
  </section>

  <!-- Raw table -->
  <section class="card" style="grid-column:1/-1">
    <div id="i.rawTitle" class="k">Tabla cruda (HR 0‚Äì23)</div>
    <table id="tbl"><thead><tr>
      <th id="i.rawIdx">Idx</th><th id="i.rawName">Nombre</th><th id="i.rawRaw">Crudo</th><th id="i.rawScaled">Escalado</th>
    </tr></thead><tbody></tbody></table>
  </section>
</main>

<!-- ====== Settings PIN Modal ====== -->
<div id="pinBackdrop" class="modal-backdrop">
  <div class="pinbox">
    <div id="i.pinTitle" class="pin-title">Ingrese PIN de Ajustes</div>
    <div class="pin-row">
      <input id="settingsPin" class="pin-input" type="password" placeholder="PIN" maxlength="8" inputmode="numeric" autofocus>
      <button id="pinOk" class="btn primary">OK</button>
    </div>
    <div id="pinErr" class="pin-err"></div>
  </div>
</div>

<!-- ====== Settings Modal ====== -->
<div id="backdrop" class="modal-backdrop">
  <div class="modal">
    <header><div id="i.cfgTitle">Configuraci√≥n</div><button id="btnClose" class="icon-btn">‚úñ</button></header>
    <div class="content">
      <p id="i.cfgHint" class="hint">Todos los ajustes se recargan en caliente. TCP y RTU espejo reinician autom√°ticamente.</p>

      <h3 id="i.upTitle">RTU de Origen (CH1)</h3>
      <div class="grid">
        <div><label id="i.upPort">Puerto</label><input id="ups_port" placeholder="/dev/ttySC0"></div>
        <div><label id="i.upBaud">Baudios</label><input id="ups_baud" type="number" placeholder="9600"></div>
        <div><label id="i.upParity">Paridad</label>
          <select id="ups_parity"><option>N</option><option>E</option><option>O</option></select>
        </div>
        <div><label id="i.upStop">Bits de parada</label><input id="ups_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label id="i.upByte">Tama√±o de byte</label><input id="ups_byte" type="number" placeholder="8" min="5" max="8"></div>
        <div><label id="i.upUnit">ID de Dispositivo</label><input id="ups_uid" type="number" placeholder="1" min="1" max="247"></div>
        <div><label id="i.upPoll">Periodo de sondeo (s)</label><input id="ups_poll" type="number" step="0.1" placeholder="1.0" min="0.1"></div>
      </div>

      <h3 id="i.mirTitle" style="margin-top:16px">RTU Espejo (CH2)</h3>
      <div class="grid">
        <div><label id="i.mirPort">Puerto</label><input id="mir_port" placeholder="/dev/ttySC1"></div>
        <div><label id="i.mirBaud">Baudios</label><input id="mir_baud" type="number" placeholder="9600"></div>
        <div><label id="i.mirParity">Paridad</label>
          <select id="mir_parity"><option>N</option><option>E</option><option>O</option></select>
        </div>
        <div><label id="i.mirStop">Bits de parada</label><input id="mir_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label id="i.mirByte">Tama√±o de byte</label><input id="mir_byte" type="number" placeholder="8" min="5" max="8"></div>
      </div>

      <h3 id="i.tcpTitle" style="margin-top:16px">Esclavo TCP</h3>
      <div class="grid">
        <div><label id="i.tcpPort">Puerto TCP</label><input id="tcp_port" type="number" placeholder="1502" min="1" max="65535"></div>
      </div>

      <h3 id="i.brandTitle" style="margin-top:16px">Marca y Dispositivo</h3>
      <div class="grid">
        <div><label id="i.lblPhone">Tel√©fono</label><input id="brand_phone" placeholder="011-4639-8310"></div>
        <div><label id="i.lblEmail">Email</label><input id="brand_email" placeholder="info@adaxtecna.com"></div>
        <div><label id="i.lblYT">URL de YouTube</label><input id="brand_youtube" placeholder="https://www.youtube.com/@adaxtecna"></div>
        <div><label id="i.lblLogo">URL del Logo</label><input id="brand_logo" placeholder="/static/adax_logo.png"></div>
        <div><label id="i.lblQR">URL de QR (opcional)</label><input id="brand_qr" placeholder=""></div>
        <div><label id="i.lblModel">Modelo (p.ej. CEA-24/20)</label><input id="device_model" placeholder="CEA-..."></div>
      </div>

      <h3 id="i.idsTitle" style="margin-top:16px">IDs Locales y Rango HR</h3>
      <div class="grid">
        <div><label id="i.u0">Unidad 0 (panel, base 0)</label><input id="u0" type="number" min="1" max="247"></div>
        <div><label id="i.u1">Unidad 1 (Modbus Poll, base 1)</label><input id="u1" type="number" min="1" max="247"></div>
        <div><label id="i.hrStart">Inicio HR</label><input id="hr_start" type="number" min="0"></div>
        <div><label id="i.hrCount">Cantidad HR</label><input id="hr_count" type="number" min="1"></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnReload">Recargar</button>
        <button class="btn primary" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  /* ==================== I18N STRINGS ==================== */
  const I18N = {
    es: {
      appTitle: "Modbus Mirror ‚Ä¢ Panel en Vivo",
      settingsBtn: "Ajustes",
      ytLink: "Visite nuestro canal de YouTube",
      modelBase: "RECTIFICADOR ADAX TECNA MODELO: {model} ‚Äî N¬∞ SERIE: ",
      gateTitle: "Ingrese PIN de Acceso",
      gateSub: "Por favor ingrese el PIN de 4 d√≠gitos para ver el panel.",
      gateEnter: "Entrar",
      gateErr: "PIN incorrecto. Int√©ntelo de nuevo.",
      measTitle: "MEDICIONES ACTUALES",
      alarmTitle: "ALARMAS",
      stateTitle: "ESTADO OPERATIVO",
      statusMode: "modo",
      statusLast: "√∫ltimo",
      tileVB: "Tensi√≥n Bater√≠a",
      tileVL: "Tensi√≥n Consumo",
      tileIB: "Corriente Bater√≠a",
      tileIL: "Corriente Consumo",
      tileIT: "Corriente Total",
      tileTA: "Temperatura Ambiente",
      rawTitle: "Tabla cruda (HR 0‚Äì23)",
      rawIdx: "Idx", rawName: "Nombre", rawRaw: "Crudo", rawScaled: "Escalado",
      pinTitle: "Ingrese PIN de Ajustes",
      cfgTitle: "Configuraci√≥n",
      cfgHint: "Todos los ajustes se recargan en caliente. TCP y RTU espejo reinician autom√°ticamente.",
      upTitle: "RTU de Origen (CH1)",
      upPort: "Puerto", upBaud: "Baudios", upParity: "Paridad", upStop: "Bits de parada",
      upByte: "Tama√±o de byte", upUnit: "ID de Dispositivo", upPoll: "Periodo de sondeo (s)",
      mirTitle: "RTU Espejo (CH2)",
      mirPort: "Puerto", mirBaud: "Baudios", mirParity: "Paridad", mirStop: "Bits de parada", mirByte: "Tama√±o de byte",
      tcpTitle: "Esclavo TCP", tcpPort: "Puerto TCP",
      brandTitle: "Marca y Dispositivo",
      lblPhone: "Tel√©fono", lblEmail: "Email", lblYT: "URL de YouTube", lblLogo: "URL del Logo", lblQR: "URL de QR (opcional)", lblModel: "Modelo (p.ej. CEA-24/20)",
      idsTitle: "IDs Locales y Rango HR", u0: "Unidad 0 (panel, base 0)", u1: "Unidad 1 (Modbus Poll, base 1)", hrStart: "Inicio HR", hrCount: "Cantidad HR",
      reload: "Recargar", save: "Guardar", saved: "Guardado.", saveFail: "Fallo al guardar", reloaded: "Ajustes recargados",
      measLabels: ["TENSI√ìN BATER√çA","TENSI√ìN CONSUMO","CORRIENTE BATER√çA","CORRIENTE CONSUMO","CORRIENTE TOTAL",'TENSI√ìN C.A. "R-N"','TENSI√ìN C.A. "S-N"','TENSI√ìN C.A. "T-N"',"TEMPERATURA AMBIENTE","TEMP. M√ÅXIMA REGISTRADA"],
      units: { vdc: "Vcc", vac: "Vca", a: "A", c: "¬∞C" },
      alarmStatus: { active: "ACTIVA", normal: "NORMAL" },
      alarms: {
        polo_tierra: "POLO A TIERRA",
        alta_v_bat: "ALTA TENSI√ìN BATER√çA",
        baja_v_bat: "BAJA TENSI√ìN BATER√çA",
        incom_consumo: "INCOMUNICACI√ìN CONSUMO",
        red_ca_anormal: "RED C.A. ANORMAL",
        alta_v_consumo: "ALTA TENSI√ìN CONSUMO",
        baja_v_consumo: "BAJA TENSI√ìN CONSUMO",
        fusible_abierto: "FUSIBLE ABIERTO",
        alta_temp: "ALTA TEMPERATURA"
      },
      states: {
        rectificador: { label: "RECTIFICADOR", on: "ENCENDIDO", off: "APAGADO" },
        bat_sentido: { label: "BATER√çA EN", charge: "CARGA", discharge: "DESCARGA" },
        modo_carga: { label: "MODO DE CARGA", manual: "MANUAL", auto: "AUTOM√ÅTICO" },
        nivel_carga: { label: "NIVEL DE CARGA", fondo: "FONDO", flote: "FLOTE" },
        timer_nicd: { label: "TIMER NiCd", started: "INICIADO", off: "DESACTIVADO" }
      }
    },
    en: {
      appTitle: "Modbus Mirror ‚Ä¢ Live Dashboard",
      settingsBtn: "Settings",
      ytLink: "Visit our YouTube channel",
      modelBase: "RECTIFIER ADAX TECNA MODEL: {model} ‚Äî SERIAL NO: ",
      gateTitle: "Enter Access PIN",
      gateSub: "Please enter the 4-digit PIN to view the dashboard.",
      gateEnter: "Enter",
      gateErr: "Incorrect PIN. Try again.",
      measTitle: "CURRENT MEASUREMENTS",
      alarmTitle: "ALARMS",
      stateTitle: "OPERATING STATE",
      statusMode: "mode",
      statusLast: "last",
      tileVB: "Battery Voltage",
      tileVL: "Load Voltage",
      tileIB: "Battery Current",
      tileIL: "Load Current",
      tileIT: "Total Current",
      tileTA: "Ambient Temp",
      rawTitle: "Raw table (HR 0‚Äì23)",
      rawIdx: "Idx", rawName: "Name", rawRaw: "Raw", rawScaled: "Scaled",
      pinTitle: "Enter Settings PIN",
      cfgTitle: "Configuration",
      cfgHint: "All settings hot-reload. TCP & Mirror RTU restart automatically.",
      upTitle: "Upstream RTU (CH1)",
      upPort: "Port", upBaud: "Baudrate", upParity: "Parity", upStop: "Stop Bits",
      upByte: "Byte Size", upUnit: "Device Unit ID", upPoll: "Poll Period (s)",
      mirTitle: "Mirror RTU (CH2)",
      mirPort: "Port", mirBaud: "Baudrate", mirParity: "Parity", mirStop: "Stop Bits", mirByte: "Byte Size",
      tcpTitle: "TCP Slave", tcpPort: "TCP Port",
      brandTitle: "Branding & Device",
      lblPhone: "Phone", lblEmail: "Email", lblYT: "YouTube URL", lblLogo: "Logo URL", lblQR: "QR Image URL (optional)", lblModel: "Model (e.g., CEA-24/20)",
      idsTitle: "Local Unit IDs & HR Range", u0: "Unit 0 (dashboard, 0-based)", u1: "Unit 1 (Modbus Poll, 1-based)", hrStart: "HR Start", hrCount: "HR Count",
      reload: "Reload", save: "Save", saved: "Saved.", saveFail: "Save failed", reloaded: "Settings reloaded",
      measLabels: ["BATTERY VOLTAGE","LOAD VOLTAGE","BATTERY CURRENT","LOAD CURRENT","TOTAL CURRENT",'AC VOLTAGE "R-N"','AC VOLTAGE "S-N"','AC VOLTAGE "T-N"',"AMBIENT TEMPERATURE","MAX RECORDED TEMP"],
      units: { vdc: "Vdc", vac: "Vac", a: "A", c: "¬∞C" },
      alarmStatus: { active: "ACTIVE", normal: "NORMAL" },
      alarms: {
        polo_tierra: "GROUND FAULT",
        alta_v_bat: "BATTERY OVERVOLTAGE",
        baja_v_bat: "BATTERY UNDERVOLTAGE",
        incom_consumo: "LOAD COMMS FAILURE",
        red_ca_anormal: "ABNORMAL AC MAINS",
        alta_v_consumo: "LOAD OVERVOLTAGE",
        baja_v_consumo: "LOAD UNDERVOLTAGE",
        fusible_abierto: "FUSE OPEN",
        alta_temp: "HIGH TEMPERATURE"
      },
      states: {
        rectificador: { label: "RECTIFIER", on: "ON", off: "OFF" },
        bat_sentido: { label: "BATTERY", charge: "CHARGE", discharge: "DISCHARGE" },
        modo_carga: { label: "CHARGE MODE", manual: "MANUAL", auto: "AUTOMATIC" },
        nivel_carga: { label: "CHARGE LEVEL", fondo: "BOOST", flote: "FLOAT" },
        timer_nicd: { label: "NiCd TIMER", started: "STARTED", off: "OFF" }
      }
    }
  };

  /* ==================== CONFIG & HELPERS ==================== */
  const ACCESS_PIN = "1234";
  const SETTINGS_PIN = "0000";
  let LANG = localStorage.getItem("lang") || "es";

  const names = [
    "BATTERY_VOLTAGE_V","LOAD_VOLTAGE_V","BATTERY_CURRENT_A","LOAD_CURRENT_A","TOTAL_CURRENT_A",
    "AC_VOLTAGE_RN_raw","AC_VOLTAGE_SN_raw","AC_VOLTAGE_TN_raw",
    "AMBIENT_TEMP_C","AMBIENT_TEMP_MAX_C","ALARM_BYTE_1_bits","ALARM_BYTE_2_bits","BATTERY_MODE_raw",
    "BATTERY_TEST_COUNT","LAST_TEST_DURATION_H","LAST_TEST_DURATION_MIN","LAST_TEST_DAY","LAST_TEST_MONTH","LAST_TEST_YEAR",
    "LAST_TEST_FINAL_BATT_V","FLOAT_CURRENT_SETPOINT_PbCa_A","NUM_CELLS_NiCd","TIMER_HOURS_NiCd","SERIAL_NUMBER_raw"
  ];

  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 2200); };
  const F=(n,u)=>typeof n==="number"&&isFinite(n)?n.toFixed(1)+" "+(u||""):"--";
  const pill2=(text,color)=>`<span class="pill2 ${color}">${text}</span>`;

  const t = (key, vars={})=>{
    const str = (I18N[LANG] && I18N[LANG][key]) || key;
    return str.replace(/\{(\w+)\}/g, (_,k)=> vars[k] ?? "");
  };
  const I = (k)=> I18N[LANG][k];

  /* ==================== LANGUAGE APPLY ==================== */
  function applyI18nStatic(){
    // Header, buttons, links
    $("i.appTitle").textContent = t("appTitle");
    $("i.settingsBtn").textContent = t("settingsBtn");
    $("ytLink").textContent = t("ytLink");

    // Gate
    $("i.gateTitle").textContent = t("gateTitle");
    $("i.gateSub").textContent = t("gateSub");
    $("gateBtn").textContent = t("gateEnter");
    $("gateErr").textContent = "";

    // Top cards
    $("i.measTitle").textContent = t("measTitle");
    $("i.alarmTitle").textContent = t("alarmTitle");
    $("i.stateTitle").textContent = t("stateTitle");

    // Status pills
    $("m").textContent = t("statusMode") + ": --";
    $("t").textContent = t("statusLast") + ": --";

    // Quick tiles labels
    $("i.tileVB").textContent = t("tileVB");
    $("i.tileVL").textContent = t("tileVL");
    $("i.tileIB").textContent = t("tileIB");
    $("i.tileIL").textContent = t("tileIL");
    $("i.tileIT").textContent = t("tileIT");
    $("i.tileTA").textContent = t("tileTA");

    // Raw table
    $("i.rawTitle").textContent = t("rawTitle");
    $("i.rawIdx").textContent = t("rawIdx");
    $("i.rawName").textContent = t("rawName");
    $("i.rawRaw").textContent = t("rawRaw");
    $("i.rawScaled").textContent = t("rawScaled");

    // Settings PIN + modal
    $("i.pinTitle").textContent = t("pinTitle");
    $("i.cfgTitle").textContent = t("cfgTitle");
    $("i.cfgHint").textContent = t("cfgHint");
    $("i.upTitle").textContent = t("upTitle");
    $("i.upPort").textContent = t("upPort");
    $("i.upBaud").textContent = t("upBaud");
    $("i.upParity").textContent = t("upParity");
    $("i.upStop").textContent = t("upStop");
    $("i.upByte").textContent = t("upByte");
    $("i.upUnit").textContent = t("upUnit");
    $("i.upPoll").textContent = t("upPoll");

    $("i.mirTitle").textContent = t("mirTitle");
    $("i.mirPort").textContent = t("mirPort");
    $("i.mirBaud").textContent = t("mirBaud");
    $("i.mirParity").textContent = t("mirParity");
    $("i.mirStop").textContent = t("mirStop");
    $("i.mirByte").textContent = t("mirByte");

    $("i.tcpTitle").textContent = t("tcpTitle");
    $("i.tcpPort").textContent = t("tcpPort");

    $("i.brandTitle").textContent = t("brandTitle");
    $("i.lblPhone").textContent = t("lblPhone");
    $("i.lblEmail").textContent = t("lblEmail");
    $("i.lblYT").textContent = t("lblYT");
    $("i.lblLogo").textContent = t("lblLogo");
    $("i.lblQR").textContent = t("lblQR");
    $("i.lblModel").textContent = t("lblModel");

    $("i.idsTitle").textContent = t("idsTitle");
    $("i.u0").textContent = t("u0");
    $("i.u1").textContent = t("u1");
    $("i.hrStart").textContent = t("hrStart");
    $("i.hrCount").textContent = t("hrCount");

    $("btnReload").textContent = t("reload");
    $("btnSave").textContent = t("save");
  }

  function applyModelLine(model, serialRaw){
    const base = t("modelBase", {model: model || "CEA"});
    $("modelLine").textContent = base + (serialRaw!=="" ? serialRaw : (LANG==="es" ? "‚Äî" : "‚Äî"));
    $("modelLine").dataset.base = base;
  }

  /* ==================== ACCESS GATE ==================== */
  function showGate(){ $("gate").style.display="flex"; $("gatePin").focus(); }
  function hideGate(){ $("gate").style.display="none"; }
  function checkGate(){ if(localStorage.getItem("dash_gate_ok")==="1"){hideGate();return;} showGate(); }
  $("gateBtn").onclick=()=>{
    const val=$("gatePin").value.trim();
    if(val===ACCESS_PIN){ localStorage.setItem("dash_gate_ok","1"); hideGate(); }
    else{ $("gateErr").textContent=t("gateErr"); $("gatePin").value=""; $("gatePin").focus(); }
  };
  $("gatePin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("gateBtn").click(); });

  /* ==================== TOP BAR FROM /api/settings ==================== */
  function renderTopbarFromSettings(js){
    const b=js.branding||{}, d=js.device||{};
    const phone=b.phone||"", email=b.email||"", yt=b.youtube||"", logo=b.logo_url||"/static/adax_logo.png", qrUrl=b.qr_url||"", model=d.model||"CEA";
    $("ytLink").textContent = t("ytLink");
    $("phoneLink").textContent=phone; $("phoneLink").href=phone?("tel:"+phone.replace(/[^\d+]/g,'')):"#";
    $("emailLink").textContent=email; $("emailLink").href=email?("mailto:"+email):"#";
    if(logo){ $("logoImg").src=logo+(logo.includes("?")?"":"?v="+Date.now()); $("logoImg").style.display="block"; } else {$("logoImg").style.display="none";}
    if(yt) $("ytLink").href=yt; else $("ytLink").removeAttribute("href");
    const finalQR = qrUrl || (yt?("https://api.qrserver.com/v1/create-qr-code/?size=120x120&data="+encodeURIComponent(yt)):"");
    if(finalQR){ $("qrImg").src=finalQR; $("qrImg").style.display="block"; } else { $("qrImg").style.display="none"; }
    applyModelLine(model, ""); // serial set in tickTiles()
  }

  /* ==================== NEW TOP CARDS ==================== */
  function renderMeasurements(m){
    const L = I("measLabels"), U = I("units");
    const rows=[
      [L[0], `${(m.battery_voltage_v??0).toFixed(1)} ${U.vdc}`],
      [L[1], `${(m.load_voltage_v??0).toFixed(1)} ${U.vdc}`],
      [L[2], `${(m.battery_current_a??0).toFixed(1)} ${U.a}`],
      [L[3], `${(m.load_current_a??0).toFixed(1)} ${U.a}`],
      [L[4], `${(m.total_current_a??0).toFixed(1)} ${U.a}`],
      [L[5], `${m.ac_rn_v??0} ${U.vac}`],
      [L[6], `${m.ac_sn_v??0} ${U.vac}`],
      [L[7], `${m.ac_tn_v??0} ${U.vac}`],
      [L[8], `${(m.ambient_temp_c??0).toFixed(1)} ${U.c}`],
      [L[9], `${(m.ambient_temp_max_c??0).toFixed(1)} ${U.c}`],
    ];
    $("measGrid").innerHTML=rows.map(([k,v])=>`<div>${k}</div><div class="mono" style="font-weight:600">${v}</div>`).join("");
  }

  function renderAlarms2(items){
    const S = I("alarmStatus"), A = I("alarms");
    $("alarmsList").innerHTML = items.map(it=>{
      const label = A[it.key] || it.label || it.key;
      const status = it.active ? pill2(S.active,"red") : pill2(S.normal,"green");
      return `<div class="kv"><div>${label}</div><div>${status}</div></div>`;
    }).join("");
  }

  function renderStates2(items){
    const ST = I("states");
    const map = {
      rectificador: x => [ST.rectificador.label, x ? ST.rectificador.on : ST.rectificador.off],
      bat_sentido:  x => [ST.bat_sentido.label,   x===1 ? ST.bat_sentido.charge : ST.bat_sentido.discharge],
      modo_carga:   x => [ST.modo_carga.label,    x ? ST.modo_carga.manual : ST.modo_carga.auto],
      nivel_carga:  x => [ST.nivel_carga.label,   x ? ST.nivel_carga.fondo : ST.nivel_carga.flote],
      timer_nicd:   x => [ST.timer_nicd.label,    x ? ST.timer_nicd.started : ST.timer_nicd.off],
    };
    $("statesList").innerHTML = items.map(it=>{
      const [label, value] = (map[it.key] ? map[it.key]( (it.valueRaw!==undefined?it.valueRaw : (it.value==="ENCENDIDO"||it.value==="ON"||it.value==="MANUAL"||it.value==="FONDO"||it.value==="STARTED")) ) : [it.label,it.value]);
      return `<div class="kv"><div>${label}</div><div>${pill2(value,it.color||"black")}</div></div>`;
    }).join("");
  }

  async function refreshTopCards(){
    // Prefer dedicated endpoints
    try{
      const [measR, alarmsR, statesR] = await Promise.allSettled([
        fetch("/api/meas2"), fetch("/api/alarms2"), fetch("/api/states2")
      ]);

      if(measR.status==="fulfilled" && measR.value.ok) renderMeasurements(await measR.value.json());
      if(alarmsR.status==="fulfilled" && alarmsR.value.ok){ const a = await alarmsR.value.json(); renderAlarms2(a.items||[]); }
      if(statesR.status==="fulfilled" && statesR.value.ok){
        const s = await statesR.value.json();
        // attach raw booleans if backend doesn't provide; harmless otherwise
        (s.items||[]).forEach(it=>{
          if(it.key==="rectificador") it.valueRaw = (it.value==="ENCENDIDO"||it.value==="ON");
          if(it.key==="bat_sentido") it.valueRaw = (it.value==="CARGA"||it.value==="CHARGE") ? 1 : 0;
          if(it.key==="modo_carga") it.valueRaw = (it.value==="MANUAL");
          if(it.key==="nivel_carga") it.valueRaw = (it.value==="FONDO"||it.value==="BOOST");
          if(it.key==="timer_nicd") it.valueRaw = (it.value==="INICIADO"||it.value==="STARTED");
        });
        renderStates2(s.items||[]);
      }
      if(measR.status==="fulfilled" && alarmsR.status==="fulfilled" && statesR.status==="fulfilled") return;
    }catch(_){}

    // Fallback to /api/hr
    try{
      const r = await fetch("/api/hr"); if(!r.ok) return;
      const js = await r.json();
      const raw = js.raw||[], s = js.scaled||{};
      const m = {
        battery_voltage_v:(s.BATTERY_VOLTAGE_V??(raw[0]/10)),
        load_voltage_v:(s.LOAD_VOLTAGE_V??(raw[1]/10)),
        battery_current_a:(s.BATTERY_CURRENT_A??(raw[2]/10)),
        load_current_a:(s.LOAD_CURRENT_A??(raw[3]/10)),
        total_current_a:(s.TOTAL_CURRENT_A??(raw[4]/10)),
        ac_rn_v: raw[5], ac_sn_v: raw[6], ac_tn_v: raw[7],
        ambient_temp_c:(s.AMBIENT_TEMP_C??(raw[8]/10)),
        ambient_temp_max_c:(s.AMBIENT_TEMP_MAX_C??(raw[9]/10))
      };
      renderMeasurements(m);

      const hr10 = raw[10]||0, hr11 = raw[11]||0, hr12 = raw[12]||0;
      const bit=(v,n)=>((v>>n)&1)?1:0;
      renderAlarms2([
        {key:"polo_tierra", active: bit(hr10,0)===1},
        {key:"alta_v_bat", active: bit(hr10,1)===1},
        {key:"baja_v_bat", active: bit(hr10,2)===1},
        {key:"incom_consumo", active: bit(hr11,0)===1},
        {key:"red_ca_anormal", active: bit(hr11,3)===1},
        {key:"alta_v_consumo", active: bit(hr11,4)===1},
        {key:"baja_v_consumo", active: bit(hr11,5)===1},
        {key:"fusible_abierto", active: bit(hr11,7)===1},
        {key:"alta_temp", active: bit(hr11,2)===1},
      ]);

      renderStates2([
        {key:"rectificador", value: bit(hr10,7)? "ENCENDIDO":"APAGADO", color: bit(hr10,7)? "green":"red", valueRaw: bit(hr10,7)},
        {key:"bat_sentido", value: hr12===1? "CARGA":"DESCARGA", color: hr12===1? "green":"red", valueRaw: hr12},
        {key:"modo_carga", value: bit(hr10,5)? "MANUAL":"AUTOM√ÅTICO", color: bit(hr10,5)? "orange":"green", valueRaw: bit(hr10,5)},
        {key:"nivel_carga", value: bit(hr10,4)? "FONDO":"FLOTE", color: "black", valueRaw: bit(hr10,4)},
        {key:"timer_nicd", value: bit(hr11,6)? "INICIADO":"DESACTIVADO", color: "black", valueRaw: bit(hr11,6)},
      ]);
    }catch(_){}
  }

  /* ==================== TILES / TABLE ==================== */
  async function tickTiles(){
    try{
      const r=await fetch("/api/hr"); const js=await r.json();
      const s=js.scaled||{};
      $("vb").textContent=F(s.BATTERY_VOLTAGE_V, I("units").vdc);
      $("vl").textContent=F(s.LOAD_VOLTAGE_V, I("units").vdc);
      $("ib").textContent=F(s.BATTERY_CURRENT_A, I("units").a);
      $("il").textContent=F(s.LOAD_CURRENT_A, I("units").a);
      $("it").textContent=F(s.TOTAL_CURRENT_A, I("units").a);
      $("ta").textContent=F(s.AMBIENT_TEMP_C, I("units").c);
      $("m").textContent=t("statusMode")+": "+(js.mode||"--");
      $("t").textContent=t("statusLast")+": "+new Date().toLocaleTimeString();

      const raw=js.raw||[];
      const serialRaw = (raw.length>23 ? raw[23] : "");
      const base = $("modelLine").dataset.base || t("modelBase",{model:"CEA"});
      $("modelLine").textContent = base + (serialRaw!=="" ? serialRaw : (LANG==="es" ? "‚Äî" : "‚Äî"));

      const tb=document.querySelector("#tbl tbody"); tb.innerHTML="";
      names.forEach((nm,i)=>{
        const tr=document.createElement("tr");
        const td=(x)=>{const d=document.createElement("td"); d.textContent=x; return d;}
        tr.appendChild(td(i));
        tr.appendChild(td(nm));
        tr.appendChild(td(raw[i]??""));
        tr.appendChild(td(typeof s[nm]==="number"?s[nm]:""));
        tb.appendChild(tr);
      });
    }catch(e){}
  }

  /* ==================== SETTINGS MODAL & PIN ==================== */
  const openConfigModal = ()=>{ $("backdrop").style.display="flex"; };
  const closeConfigModal = ()=>{ $("backdrop").style.display="none"; };

  const openSettingsPin = ()=>{
    $("pinBackdrop").style.display="flex";
    $("settingsPin").value=""; $("pinErr").textContent="";
    setTimeout(()=>$("settingsPin").focus(), 10);
  };
  const closeSettingsPin = ()=>{ $("pinBackdrop").style.display="none"; };

  $("btnSettings").onclick = ()=>{ openSettingsPin(); };
  $("pinBackdrop").addEventListener("click",(e)=>{ if(e.target===$("pinBackdrop")) closeSettingsPin(); });
  $("pinOk").onclick = ()=>{
    if ($("settingsPin").value.trim() === SETTINGS_PIN) {
      closeSettingsPin(); openConfigModal();
    } else {
      $("pinErr").textContent = (LANG==="es"?"PIN incorrecto. Int√©ntelo de nuevo.":"Incorrect PIN. Try again.");
      $("settingsPin").value = ""; $("settingsPin").focus();
    }
  };
  $("settingsPin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("pinOk").click(); });
  $("btnClose").onclick = closeConfigModal;
  $("backdrop").addEventListener("click",(e)=>{ if(e.target===$("backdrop")) closeConfigModal(); });

  async function fillSettings(){
    const r = await fetch("/api/settings"); const js = await r.json();
    renderTopbarFromSettings(js);
    const u=js.upstream, m=js.mirror_rtu, tcfg=js.tcp, lu=js.local_units, hr=js.hr, b=js.branding||{}, d=js.device||{};
    $("ups_port").value=u.port; $("ups_baud").value=u.baudrate; $("ups_parity").value=u.parity;
    $("ups_stop").value=u.stopbits; $("ups_byte").value=u.bytesize; $("ups_uid").value=u.device_unit_id;
    $("ups_poll").value=u.poll_period_s;
    $("mir_port").value=m.port; $("mir_baud").value=m.baudrate; $("mir_parity").value=m.parity;
    $("mir_stop").value=m.stopbits; $("mir_byte").value=m.bytesize;
    $("tcp_port").value=tcfg.port;
    $("brand_phone").value=b.phone||""; $("brand_email").value=b.email||"";
    $("brand_youtube").value=b.youtube||""; $("brand_logo").value=b.logo_url||"";
    $("brand_qr").value=b.qr_url||""; $("device_model").value=d.model||"";
    $("u0").value=lu.unit0_id; $("u1").value=lu.unit1_id;
    $("hr_start").value=hr.start; $("hr_count").value=hr.count;
    // Re-apply model line (with correct language)
    applyModelLine(d.model||"CEA", "");
  }
  $("btnReload").onclick = async ()=>{ await fillSettings(); toast(t("reloaded")); };

  $("btnSave").onclick = async ()=>{
    const btn=$("btnSave"); btn.disabled=true; const original=btn.textContent; btn.textContent = (LANG==="es"?"Guardando‚Ä¶":"Saving‚Ä¶");
    const payload = {
      upstream:{ port:$("ups_port").value, baudrate:+$("ups_baud").value, parity:$("ups_parity").value,
                 stopbits:+$("ups_stop").value, bytesize:+$("ups_byte").value, device_unit_id:+$("ups_uid").value,
                 poll_period_s:+$("ups_poll").value },
      mirror_rtu:{ port:$("mir_port").value, baudrate:+$("mir_baud").value, parity:$("mir_parity").value,
                   stopbits:+$("mir_stop").value, bytesize:+$("mir_byte").value },
      tcp:{ port:+$("tcp_port").value },
      local_units:{ unit0_id:+$("u0").value, unit1_id:+$("u1").value },
      hr:{ start:+$("hr_start").value, count:+$("hr_count").value },
      branding:{ phone:$("brand_phone").value, email:$("brand_email").value, youtube:$("brand_youtube").value,
                 logo_url:$("brand_logo").value, qr_url:$("brand_qr").value },
      device:{ model:$("device_model").value }
    };
    try{
      const r=await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      const js=await r.json();
      if(js.ok){ await fillSettings(); toast(t("saved")); closeConfigModal(); }
      else{ toast(js.detail||t("saveFail")); }
    }catch(e){ toast(t("saveFail")); }
    finally{ btn.disabled=false; btn.textContent=original; }
  };

  /* ==================== MAIN LOOPS & LANG SWITCH ==================== */
  async function mainTick(){
    await Promise.all([tickTiles(), refreshTopCards()]);
    setTimeout(mainTick, 1000);
  }

  const langSel = $("langSel");
  langSel.value = LANG;
  langSel.addEventListener("change", ()=>{
    LANG = langSel.value || "es";
    localStorage.setItem("lang", LANG);
    applyI18nStatic();
  });

  document.addEventListener("DOMContentLoaded", async ()=>{
    applyI18nStatic();
    $("gateBtn").textContent = t("gateEnter");
    checkGate();
    if (localStorage.getItem("dash_gate_ok")==="1") { await fillSettings(); }
    mainTick();
  });
</script>
