<!doctype html><meta charset="utf-8">
<title>Modbus Mirror Dashboard</title>
<style>
 body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;margin:0;background:#0b1220;color:#e8eefc}
 header{padding:12px 16px;border-bottom:1px solid #223;font-weight:600;display:flex;align-items:center;justify-content:space-between}
 main{padding:16px;display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
 .card{background:#111a2b;border:1px solid #223;border-radius:14px;padding:14px}
 .k{font-size:12px;color:#88a;text-transform:uppercase;letter-spacing:.1em}
 .v{font-size:28px;margin-top:6px}
 table{width:100%;border-collapse:collapse;font-size:14px}
 th,td{padding:6px 8px;border-bottom:1px solid #223;text-align:left}
 .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
 .pill{font-size:12px;color:#88a;padding:2px 8px;border:1px solid #223;border-radius:999px}
 .icon-btn{cursor:pointer;border:1px solid #223;background:#0f1830;color:#9fc3ff;border-radius:10px;padding:6px 10px}
 .icon-btn:hover{background:#13213d}
 /* Modal */
 .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
 .modal{background:#0f1830;border:1px solid #223;border-radius:14px;width:min(720px,92vw);max-height:86vh;overflow:auto}
 .modal header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #223}
 .modal .content{padding:16px}
 .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
 label{font-size:12px;color:#9ab}
 input,select{width:100%;padding:8px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
 .hint{font-size:12px;color:#8aa}
 .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
 .btn{padding:8px 12px;border-radius:10px;border:1px solid #223;background:#111a2b;color:#e8eefc;cursor:pointer}
 .btn.primary{background:#2956cc}
 .btn.warn{background:#8a2c2c}
 .toast{position:fixed;bottom:16px;right:16px;background:#11213a;border:1px solid #2a3b66;padding:10px 12px;border-radius:10px;display:none}
 a{color:#9fc3ff}
 .alarm-pill{display:flex;flex-direction:column;gap:4px;border:1px solid #223;border-radius:10px;padding:8px;background:#101a30}
  .alarm-title{font-size:13px;color:#9ab}
  .alarm-val{font-size:14px;font-weight:600}
  .red{color:#ff6b6b}
  .green{color:#41d888}
</style>

<header>
<!-- Alarm Card just under header -->
<section class="card" style="grid-column:1/-1; display:flex; align-items:flex-start; justify-content:space-between; gap:12px">
  <div style="font-weight:600">Alarms</div>
  <div id="alarms" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px; width:100%; margin-left:12px"></div>
</section>

  <div>Modbus Mirror • Live Dashboard</div>
  <button id="btnSettings" class="icon-btn" title="Settings">⚙️ Settings</button>
</header>

<main>
 <section class="card" style="grid-column:1/-1">
  <div class="row">
   <div class="pill" id="m">mode: --</div>
   <div class="pill" id="t">last: --</div>
   <div class="pill"><a href="/api/hr" target="_blank">/api/hr</a></div>
   <div class="pill"><a href="/api/debug_store" target="_blank">/api/debug_store</a></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px">
   <div class="card"><div class="k">Battery Voltage</div><div class="v" id="vb">--</div></div>
   <div class="card"><div class="k">Load Voltage</div><div class="v" id="vl">--</div></div>
   <div class="card"><div class="k">Battery Current</div><div class="v" id="ib">--</div></div>
   <div class="card"><div class="k">Load Current</div><div class="v" id="il">--</div></div>
   <div class="card"><div class="k">Total Current</div><div class="v" id="it">--</div></div>
   <div class="card"><div class="k">Ambient Temp</div><div class="v" id="ta">--</div></div>
  </div>
 </section>
 <section class="card" style="grid-column:1/-1">
  <div class="k">Raw table (HR 0–23)</div>
  <table id="tbl"><thead><tr><th>Idx</th><th>Name</th><th>Raw</th><th>Scaled</th></tr></thead><tbody></tbody></table>
 </section>
</main>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop">
  <div class="modal">
    <header><div>Configuration</div><button id="btnClose" class="icon-btn">✖</button></header>
    <div class="content">
      <p class="hint">Changes to <b>Upstream RTU</b> apply live. Changes to <b>TCP port</b> or <b>Mirror RTU</b> require restarting this service.</p>

      <h3>Upstream RTU (CH1)</h3>
      <div class="grid">
        <div><label>Port</label><input id="ups_port" placeholder="/dev/ttySC0"></div>
        <div><label>Baudrate</label><input id="ups_baud" type="number" placeholder="9600"></div>
        <div><label>Parity</label>
          <select id="ups_parity">
            <option>N</option><option>E</option><option>O</option>
          </select></div>
        <div><label>Stop Bits</label><input id="ups_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label>Byte Size</label><input id="ups_byte" type="number" placeholder="8" min="5" max="8"></div>
        <div><label>Device Unit ID</label><input id="ups_uid" type="number" placeholder="1" min="1" max="247"></div>
        <div><label>Poll Period (s)</label><input id="ups_poll" type="number" step="0.1" placeholder="1.0" min="0.1"></div>
      </div>

      <h3 style="margin-top:16px">Mirror RTU (CH2)</h3>
      <div class="grid">
        <div><label>Port</label><input id="mir_port" placeholder="/dev/ttySC1"></div>
        <div><label>Baudrate</label><input id="mir_baud" type="number" placeholder="9600"></div>
        <div><label>Parity</label>
          <select id="mir_parity">
            <option>N</option><option>E</option><option>O</option>
          </select></div>
        <div><label>Stop Bits</label><input id="mir_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label>Byte Size</label><input id="mir_byte" type="number" placeholder="8" min="5" max="8"></div>
      </div>

      <h3 style="margin-top:16px">TCP Slave</h3>
      <div class="grid">
        <div><label>TCP Port</label><input id="tcp_port" type="number" placeholder="1502" min="1" max="65535"></div>
      </div>

      <h3 style="margin-top:16px">Local Unit IDs & HR Range</h3>
      <div class="grid">
        <div><label>Unit 0 (dashboard, 0-based)</label><input id="u0" type="number" min="1" max="247"></div>
        <div><label>Unit 1 (Modbus Poll, 1-based)</label><input id="u1" type="number" min="1" max="247"></div>
        <div><label>HR Start</label><input id="hr_start" type="number" min="0"></div>
        <div><label>HR Count</label><input id="hr_count" type="number" min="1"></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnReload">Reload from Server</button>
        <button class="btn primary" id="btnSave">Save</button>
      </div>
      <p class="hint">Tip: After saving TCP or mirror RTU changes, restart the service to apply them.</p>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const names = [
 "BATTERY_VOLTAGE_V","LOAD_VOLTAGE_V","BATTERY_CURRENT_A","LOAD_CURRENT_A","TOTAL_CURRENT_A",
 "AC_VOLTAGE_RN_raw","AC_VOLTAGE_SN_raw","AC_VOLTAGE_TN_raw",
 "AMBIENT_TEMP_C","AMBIENT_TEMP_MAX_C","ALARM_BYTE_1_bits","ALARM_BYTE_2_bits","BATTERY_MODE_raw",
 "BATTERY_TEST_COUNT","LAST_TEST_DURATION_H","LAST_TEST_DURATION_MIN","LAST_TEST_DAY","LAST_TEST_MONTH","LAST_TEST_YEAR",
 "LAST_TEST_FINAL_BATT_V","FLOAT_CURRENT_SETPOINT_PbCa_A","NUM_CELLS_NiCd","TIMER_HOURS_NiCd","SERIAL_NUMBER_raw"
];
const F=(n,u)=>typeof n==="number"&&isFinite(n)?n.toFixed(1)+" "+(u||""):"--";
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 2500); };

async function tick(){
  try{
    const r=await fetch("/api/hr"); const js=await r.json();
    const s=js.scaled||{};
    $("vb").textContent=F(s.BATTERY_VOLTAGE_V,"V");
    $("vl").textContent=F(s.LOAD_VOLTAGE_V,"V");
    $("ib").textContent=F(s.BATTERY_CURRENT_A,"A");
    $("il").textContent=F(s.LOAD_CURRENT_A,"A");
    $("it").textContent=F(s.TOTAL_CURRENT_A,"A");
    $("ta").textContent=F(s.AMBIENT_TEMP_C,"°C");
    $("m").textContent="mode: "+(js.mode||"--");
    $("t").textContent="last: "+new Date().toLocaleTimeString();
    const tb=document.querySelector("#tbl tbody"); tb.innerHTML="";
    const raw=js.raw||[];
    names.forEach((nm,i)=>{
      const tr=document.createElement("tr");
      const td=(x)=>{const d=document.createElement("td"); d.textContent=x; return d;}
      tr.appendChild(td(i));
      tr.appendChild(td(nm));
      tr.appendChild(td(raw[i]??""));
      tr.appendChild(td(typeof s[nm]==="number"?s[nm]:""));
      tb.appendChild(tr);
    });
  }catch(e){}
}
setInterval(tick, 1000); tick();

// ---- Settings modal ----
const openModal = ()=>{ $("backdrop").style.display="flex"; };
const closeModal = ()=>{ $("backdrop").style.display="none"; };

$("btnSettings").onclick = openModal;
$("btnClose").onclick = closeModal;

async function fillSettings(){
  const r = await fetch("/api/settings"); const js = await r.json();
  const u=js.upstream, m=js.mirror_rtu, t=js.tcp, lu=js.local_units, hr=js.hr;
  $("ups_port").value=u.port; $("ups_baud").value=u.baudrate; $("ups_parity").value=u.parity;
  $("ups_stop").value=u.stopbits; $("ups_byte").value=u.bytesize; $("ups_uid").value=u.device_unit_id;
  $("ups_poll").value=u.poll_period_s;

  $("mir_port").value=m.port; $("mir_baud").value=m.baudrate; $("mir_parity").value=m.parity;
  $("mir_stop").value=m.stopbits; $("mir_byte").value=m.bytesize;

  $("tcp_port").value=t.port;

  $("u0").value=lu.unit0_id; $("u1").value=lu.unit1_id;
  $("hr_start").value=hr.start; $("hr_count").value=hr.count;
}
$("btnReload").onclick = async ()=>{ await fillSettings(); toast("Settings reloaded"); };

$("btnSave").onclick = async ()=>{
  const payload = {
    upstream: {
      port: $("ups_port").value,
      baudrate: Number($("ups_baud").value),
      parity: $("ups_parity").value,
      stopbits: Number($("ups_stop").value),
      bytesize: Number($("ups_byte").value),
      device_unit_id: Number($("ups_uid").value),
      poll_period_s: Number($("ups_poll").value)
    },
    mirror_rtu: {
      port: $("mir_port").value,
      baudrate: Number($("mir_baud").value),
      parity: $("mir_parity").value,
      stopbits: Number($("mir_stop").value),
      bytesize: Number($("mir_byte").value)
    },
    tcp: { port: Number($("tcp_port").value) },
    local_units: {
      unit0_id: Number($("u0").value),
      unit1_id: Number($("u1").value)
    },
    hr: {
      start: Number($("hr_start").value),
      count: Number($("hr_count").value)
    }
  };
  try{
    const r = await fetch("/api/settings", {method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
    const js = await r.json();
    if(js.ok){ toast("Saved. (TCP/mirror changes need restart)"); }
    else { toast(js.detail || "Save failed"); }
  }catch(e){ toast("Save failed"); }
};

document.addEventListener("DOMContentLoaded", fillSettings);


async function renderAlarms(){
  try{
    const r = await fetch("/api/alarms");
    const js = await r.json();
    const root = document.getElementById("alarms");
    root.innerHTML = "";
    (js.alarms || []).forEach(a=>{
      const card = document.createElement("div");
      card.className = "alarm-pill";
      const t = document.createElement("div");
      t.className = "alarm-title";
      t.textContent = a.name;
      const v = document.createElement("div");
      v.className = "alarm-val " + (a.color === "red" ? "red" : "green");
      v.textContent = (a.on ? "ALARM" : "OK") + " — " + (a.msg || "");
      card.appendChild(t);
      card.appendChild(v);
      root.appendChild(card);
    });
  }catch(e){}
}
setInterval(()=>{ tick(); renderAlarms(); }, 1000);
renderAlarms();
</script>
