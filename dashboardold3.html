<!doctype html><meta charset="utf-8">
<title>Modbus Mirror Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;margin:0;background:#0b1220;color:#e8eefc}
  header{padding:12px 16px;border-bottom:1px solid #223;font-weight:600;display:flex;align-items:center;justify-content:space-between}
  main{padding:16px;display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:#111a2b;border:1px solid #223;border-radius:14px;padding:14px}
  .k{font-size:12px;color:#88a;text-transform:uppercase;letter-spacing:.1em}
  .v{font-size:28px;margin-top:6px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:6px 8px;border-bottom:1px solid #223;text-align:left}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{font-size:12px;color:#88a;padding:2px 8px;border:1px solid #223;border-radius:999px}
  .icon-btn{cursor:pointer;border:1px solid #223;background:#0f1830;color:#9fc3ff;border-radius:10px;padding:6px 10px}
  .icon-btn:hover{background:#13213d}
  a{color:#9fc3ff}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#0f1830;border:1px solid #223;border-radius:14px;width:min(820px,92vw);max-height:86vh;overflow:auto}
  .modal header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #223;padding:12px 16px}
  .modal .content{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  label{font-size:12px;color:#9ab}
  input,select{width:100%;padding:8px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
  .hint{font-size:12px;color:#8aa}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #223;background:#111a2b;color:#e8eefc;cursor:pointer}
  .btn.primary{background:#2956cc}
  .toast{position:fixed;bottom:16px;right:16px;background:#11213a;border:1px solid #2a3b66;padding:10px 12px;border-radius:10px;display:none;z-index:1200}

  /* Top info strip */
  .topbar{background:#bcd5e8;color:#073b5a}
  .topbar-inner{max-width:1400px;margin:0 auto;padding:8px 12px;display:grid;align-items:center;gap:8px;grid-template-columns:1fr auto auto}
  .top-left{display:flex;flex-direction:column;gap:6px;font-weight:600}
  .top-left a{color:#0a4f79;text-decoration:none}
  .top-center{display:flex;align-items:center;gap:12px}
  .qr{width:96px;height:96px;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .qr img{width:96px;height:96px;display:block}
  .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .logo{height:36px;object-fit:contain}
  .yt{color:#0a4f79;text-decoration:none;font-weight:700}
  .model-line{background:#a7c8de;font-weight:700;margin-top:6px;padding:6px 10px;border-radius:6px}
  .model-line span{color:#062e46}

  /* Alarms */
  .alarm-wrap{grid-column:1/-1; display:flex; justify-content:flex-end;}
  .alarm-card{width:min(520px,100%); display:flex; align-items:flex-start; gap:12px}
  .alarm-title-main{font-weight:600; white-space:nowrap}
  .alarm-list{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px; width:100%}
  .alarm-pill{display:flex;flex-direction:column;gap:4px;border:1px solid #223;border-radius:10px;padding:8px;background:#101a30}
  .alarm-title{font-size:13px;color:#9ab}
  .alarm-val{font-size:14px;font-weight:600}
  .red{color:#ff6b6b}
  .green{color:#41d888}

  /* Full-screen PIN Gate */
  .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1220,#0d1a33);display:flex;align-items:center;justify-content:center;z-index:2000}
  .gate-card{background:#0f1830;border:1px solid #223;border-radius:16px;padding:20px;width:min(420px,92vw);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .gate-title{font-size:18px;font-weight:700;margin-bottom:8px}
  .gate-sub{color:#9ab;font-size:13px;margin-bottom:12px}
  .gate-row{display:flex;gap:8px;align-items:center}
  .gate-input{flex:1;padding:10px;border-radius:10px;border:1px solid #294;outline:none;background:#0b1220;color:#e8eefc;font-size:16px}
  .gate-btn{padding:10px 14px;border-radius:10px;border:1px solid #223;background:#2956cc;color:#fff;cursor:pointer}
  .gate-err{color:#ff6b6b;font-size:13px;margin-top:8px;min-height:18px}

  /* Settings PIN mini modal */
  .pinbox{background:#0f1830;border:1px solid #223;border-radius:16px;padding:16px;width:min(360px,92vw)}
  .pin-title{font-weight:700;margin-bottom:6px}
  .pin-row{display:flex;gap:8px}
  .pin-input{flex:1;padding:10px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
  .pin-err{color:#ff6b6b;font-size:13px;margin-top:6px;min-height:18px}

  @media (max-width: 640px){
    .alarm-wrap{justify-content:flex-start;}
    .topbar-inner{grid-template-columns:1fr;gap:12px}
    .top-right{align-items:flex-start}
  }
</style>

<!-- Full-screen PIN Gate (PIN: 1234) -->
<div id="gate" class="gate" style="display:none">
  <div class="gate-card">
    <div class="gate-title">Enter Access PIN</div>
    <div class="gate-sub">Please enter the 4-digit PIN to view the dashboard.</div>
    <div class="gate-row">
      <input id="gatePin" class="gate-input" type="password" placeholder="PIN" maxlength="8" inputmode="numeric" autofocus>
      <button id="gateBtn" class="gate-btn">Enter</button>
    </div>
    <div id="gateErr" class="gate-err"></div>
  </div>
</div>

<!-- Top company strip -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="top-left">
      <div>üìû <a id="phoneLink" href="#">011-4639-8310</a></div>
      <div>‚úâÔ∏è <a id="emailLink" href="#">info@adaxtecna.com</a></div>
    </div>
    <div class="top-center">
      <div class="qr"><img id="qrImg" alt="QR"></div>
    </div>
    <div class="top-right">
      <!-- default src so it shows even before settings arrive -->
      <img id="logoImg" class="logo" alt="Logo" src="/static/adax_logo.png"/>
      <a id="ytLink" class="yt" href="#" target="_blank">Visit our YouTube channel</a>
      <div class="model-line">
        <span id="modelLine">RECTIFIER ADAX TECNA MODEL: CEA ‚Äî SERIAL NO: ‚Äî</span>
      </div>
    </div>
  </div>
</div>

<header>
  <div>Modbus Mirror ‚Ä¢ Live Dashboard</div>
  <button id="btnSettings" class="icon-btn" title="Settings">‚öôÔ∏è Settings</button>
</header>

<main>
  <!-- Alarms card -->
  <section class="card alarm-wrap">
    <div class="alarm-card">
      <div class="alarm-title-main">Alarms</div>
      <div id="alarms" class="alarm-list"></div>
    </div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="row">
      <div class="pill" id="m">mode: --</div>
      <div class="pill" id="t">last: --</div>
      <div class="pill"><a href="/api/hr" target="_blank">/api/hr</a></div>
      <div class="pill"><a href="/api/debug_store" target="_blank">/api/debug_store</a></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px">
      <div class="card"><div class="k">Battery Voltage</div><div class="v" id="vb">--</div></div>
      <div class="card"><div class="k">Load Voltage</div><div class="v" id="vl">--</div></div>
      <div class="card"><div class="k">Battery Current</div><div class="v" id="ib">--</div></div>
      <div class="card"><div class="k">Load Current</div><div class="v" id="il">--</div></div>
      <div class="card"><div class="k">Total Current</div><div class="v" id="it">--</div></div>
      <div class="card"><div class="k">Ambient Temp</div><div class="v" id="ta">--</div></div>
    </div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="k">Raw table (HR 0‚Äì23)</div>
    <table id="tbl"><thead><tr><th>Idx</th><th>Name</th><th>Raw</th><th>Scaled</th></tr></thead><tbody></tbody></table>
  </section>
</main>

<!-- Settings PIN Modal (PIN: 0000) -->
<div id="pinBackdrop" class="modal-backdrop">
  <div class="pinbox">
    <div class="pin-title">Enter Settings PIN</div>
    <div class="pin-row">
      <input id="settingsPin" class="pin-input" type="password" placeholder="PIN" maxlength="8" inputmode="numeric" autofocus>
      <button id="pinOk" class="btn primary">OK</button>
    </div>
    <div id="pinErr" class="pin-err"></div>
  </div>
</div>

<!-- Settings Modal -->
<div id="backdrop" class="modal-backdrop">
  <div class="modal">
    <header><div>Configuration</div><button id="btnClose" class="icon-btn">‚úñ</button></header>
    <div class="content">
      <p class="hint">All settings hot-reload. TCP & Mirror RTU restart automatically.</p>

      <h3>Upstream RTU (CH1)</h3>
      <div class="grid">
        <div><label>Port</label><input id="ups_port" placeholder="/dev/ttySC0"></div>
        <div><label>Baudrate</label><input id="ups_baud" type="number" placeholder="9600"></div>
        <div><label>Parity</label>
          <select id="ups_parity"><option>N</option><option>E</option><option>O</option></select>
        </div>
        <div><label>Stop Bits</label><input id="ups_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label>Byte Size</label><input id="ups_byte" type="number" placeholder="8" min="5" max="8"></div>
        <div><label>Device Unit ID</label><input id="ups_uid" type="number" placeholder="1" min="1" max="247"></div>
        <div><label>Poll Period (s)</label><input id="ups_poll" type="number" step="0.1" placeholder="1.0" min="0.1"></div>
      </div>

      <h3 style="margin-top:16px">Mirror RTU (CH2)</h3>
      <div class="grid">
        <div><label>Port</label><input id="mir_port" placeholder="/dev/ttySC1"></div>
        <div><label>Baudrate</label><input id="mir_baud" type="number" placeholder="9600"></div>
        <div><label>Parity</label>
          <select id="mir_parity"><option>N</option><option>E</option><option>O</option></select>
        </div>
        <div><label>Stop Bits</label><input id="mir_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label>Byte Size</label><input id="mir_byte" type="number" placeholder="8" min="5" max="8"></div>
      </div>

      <h3 style="margin-top:16px">TCP Slave</h3>
      <div class="grid">
        <div><label>TCP Port</label><input id="tcp_port" type="number" placeholder="1502" min="1" max="65535"></div>
      </div>

      <h3 style="margin-top:16px">Branding & Device</h3>
      <div class="grid">
        <div><label>Phone</label><input id="brand_phone" placeholder="011-4639-8310"></div>
        <div><label>Email</label><input id="brand_email" placeholder="info@adaxtecna.com"></div>
        <div><label>YouTube URL</label><input id="brand_youtube" placeholder="https://www.youtube.com/@adaxtecna"></div>
        <div><label>Logo URL</label><input id="brand_logo" placeholder="/static/adax_logo.png"></div>
        <div><label>QR Image URL (optional)</label><input id="brand_qr" placeholder=""></div>
        <div><label>Model (e.g. CEA-24/20)</label><input id="device_model" placeholder="CEA-..."></div>
      </div>

      <h3 style="margin-top:16px">Local Unit IDs & HR Range</h3>
      <div class="grid">
        <div><label>Unit 0 (dashboard, 0-based)</label><input id="u0" type="number" min="1" max="247"></div>
        <div><label>Unit 1 (Modbus Poll, 1-based)</label><input id="u1" type="number" min="1" max="247"></div>
        <div><label>HR Start</label><input id="hr_start" type="number" min="0"></div>
        <div><label>HR Count</label><input id="hr_count" type="number" min="1"></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnReload">Reload from Server</button>
        <button class="btn primary" id="btnSave">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  const ACCESS_PIN = "1234";
  const SETTINGS_PIN = "0000";

  const names = [
    "BATTERY_VOLTAGE_V","LOAD_VOLTAGE_V","BATTERY_CURRENT_A","LOAD_VOLTAGE_V","TOTAL_CURRENT_A",
    "AC_VOLTAGE_RN_raw","AC_VOLTAGE_SN_raw","AC_VOLTAGE_TN_raw",
    "AMBIENT_TEMP_C","AMBIENT_TEMP_MAX_C","ALARM_BYTE_1_bits","ALARM_BYTE_2_bits","BATTERY_MODE_raw",
    "BATTERY_TEST_COUNT","LAST_TEST_DURATION_H","LAST_TEST_DURATION_MIN","LAST_TEST_DAY","LAST_TEST_MONTH","LAST_TEST_YEAR",
    "LAST_TEST_FINAL_BATT_V","FLOAT_CURRENT_SETPOINT_PbCa_A","NUM_CELLS_NiCd","TIMER_HOURS_NiCd","SERIAL_NUMBER_raw"
  ];
  const F=(n,u)=>typeof n==="number"&&isFinite(n)?n.toFixed(1)+" "+(u||""):"--";
  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 2200); };

  // ---------- Access gate ----------
  function showGate() { $("gate").style.display = "flex"; $("gatePin").focus(); }
  function hideGate() { $("gate").style.display = "none"; }
  function checkGate() {
    if (localStorage.getItem("dash_gate_ok") === "1") { hideGate(); return; }
    showGate();
  }
  $("gateBtn").onclick = ()=>{
    const val = $("gatePin").value.trim();
    if (val === ACCESS_PIN) {
      localStorage.setItem("dash_gate_ok","1");
      hideGate();
    } else {
      $("gateErr").textContent = "Incorrect PIN. Try again.";
      $("gatePin").value = "";
      $("gatePin").focus();
    }
  };
  $("gatePin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("gateBtn").click(); });

  // ---------- Top bar from /api/settings ----------
  function renderTopbarFromSettings(js){
    const b = js.branding || {};
    const d = js.device || {};
    const phone = b.phone || "";
    const email = b.email || "";
    const yt = b.youtube || "";
    const logo = b.logo_url || "/static/adax_logo.png";
    const qrUrl = b.qr_url || "";
    const model = d.model || "CEA";

    const phoneDigits = phone.replace(/[^\d+]/g,'');
    $("phoneLink").textContent = phone || "";
    $("phoneLink").href = phoneDigits ? ("tel:" + phoneDigits) : "#";
    $("emailLink").textContent = email || "";
    $("emailLink").href = email ? ("mailto:" + email) : "#";

    if (logo) { $("logoImg").src = logo + (logo.includes("?") ? "" : "?v=" + Date.now()); $("logoImg").style.display="block"; }
    else { $("logoImg").style.display="none"; }
    if (yt) { $("ytLink").href = yt; } else { $("ytLink").removeAttribute("href"); }

    const finalQR = qrUrl || (yt ? ("https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=" + encodeURIComponent(yt)) : "");
    if (finalQR) { $("qrImg").src = finalQR; $("qrImg").style.display="block"; } else { $("qrImg").style.display="none"; }

    const base = "RECTIFIER ADAX TECNA MODEL: " + model + " ‚Äî SERIAL NO: ";
    $("modelLine").textContent = base + "‚Äî";
    $("modelLine").dataset.base = base;
  }

  async function tick(){
    try{
      const r=await fetch("/api/hr"); const js=await r.json();
      const s=js.scaled||{};
      $("vb").textContent=F(s.BATTERY_VOLTAGE_V,"V");
      $("vl").textContent=F(s.LOAD_VOLTAGE_V,"V");
      $("ib").textContent=F(s.BATTERY_CURRENT_A,"A");
      $("il").textContent=F(s.LOAD_CURRENT_A,"A");
      $("it").textContent=F(s.TOTAL_CURRENT_A,"A");
      $("ta").textContent=F(s.AMBIENT_TEMP_C,"¬∞C");
      $("m").textContent="mode: "+(js.mode||"--");
      $("t").textContent="last: "+new Date().toLocaleTimeString();

      const raw=js.raw||[];
      const serialRaw = (raw.length>23 ? raw[23] : "");
      const base = $("modelLine").dataset.base || "RECTIFIER ADAX TECNA MODEL: CEA ‚Äî SERIAL NO: ";
      $("modelLine").textContent = base + (serialRaw!=="" ? serialRaw : "‚Äî");

      const tb=document.querySelector("#tbl tbody"); tb.innerHTML="";
      names.forEach((nm,i)=>{
        const tr=document.createElement("tr");
        const td=(x)=>{const d=document.createElement("td"); d.textContent=x; return d;}
        tr.appendChild(td(i));
        tr.appendChild(td(nm));
        tr.appendChild(td(raw[i]??""));
        tr.appendChild(td(typeof s[nm]==="number"?s[nm]:""));
        tb.appendChild(tr);
      });
    }catch(e){}
  }
  setInterval(tick, 1000); tick();

  // ---------- Settings modal + settings PIN ----------
  const openConfigModal = ()=>{ $("backdrop").style.display="flex"; };
  const closeConfigModal = ()=>{ $("backdrop").style.display="none"; };

  const openSettingsPin = ()=>{
    $("pinBackdrop").style.display="flex";
    $("settingsPin").value="";
    $("pinErr").textContent="";
    setTimeout(()=>$("settingsPin").focus(), 10);
  };
  const closeSettingsPin = ()=>{ $("pinBackdrop").style.display="none"; };

  $("btnSettings").onclick = ()=>{
    // ask for settings pin first
    openSettingsPin();
  };
  $("pinBackdrop").addEventListener("click",(e)=>{ if(e.target===$("pinBackdrop")) closeSettingsPin(); });
  $("pinOk").onclick = ()=>{
    if ($("settingsPin").value.trim() === SETTINGS_PIN) {
      closeSettingsPin();
      openConfigModal();
    } else {
      $("pinErr").textContent = "Incorrect PIN. Try again.";
      $("settingsPin").value = "";
      $("settingsPin").focus();
    }
  };
  $("settingsPin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("pinOk").click(); });

  $("btnClose").onclick = closeConfigModal;
  $("backdrop").addEventListener("click",(e)=>{ if(e.target===$("backdrop")) closeConfigModal(); });

  async function fillSettings(){
    const r = await fetch("/api/settings"); const js = await r.json();
    renderTopbarFromSettings(js);

    const u=js.upstream, m=js.mirror_rtu, t=js.tcp, lu=js.local_units, hr=js.hr, b=js.branding||{}, d=js.device||{};
    $("ups_port").value=u.port; $("ups_baud").value=u.baudrate; $("ups_parity").value=u.parity;
    $("ups_stop").value=u.stopbits; $("ups_byte").value=u.bytesize; $("ups_uid").value=u.device_unit_id;
    $("ups_poll").value=u.poll_period_s;

    $("mir_port").value=m.port; $("mir_baud").value=m.baudrate; $("mir_parity").value=m.parity;
    $("mir_stop").value=m.stopbits; $("mir_byte").value=m.bytesize;

    $("tcp_port").value=t.port;

    $("brand_phone").value=b.phone||"";
    $("brand_email").value=b.email||"";
    $("brand_youtube").value=b.youtube||"";
    $("brand_logo").value=b.logo_url||"";
    $("brand_qr").value=b.qr_url||"";
    $("device_model").value=d.model||"";

    $("u0").value=lu.unit0_id; $("u1").value=lu.unit1_id;
    $("hr_start").value=hr.start; $("hr_count").value=hr.count;
  }
  $("btnReload").onclick = async ()=>{ await fillSettings(); toast("Settings reloaded"); };

  $("btnSave").onclick = async ()=>{
    const btn = $("btnSave");
    btn.disabled = true;
    const original = btn.textContent;
    btn.textContent = "Saving‚Ä¶";

    const payload = {
      upstream: {
        port: $("ups_port").value,
        baudrate: Number($("ups_baud").value),
        parity: $("ups_parity").value,
        stopbits: Number($("ups_stop").value),
        bytesize: Number($("ups_byte").value),
        device_unit_id: Number($("ups_uid").value),
        poll_period_s: Number($("ups_poll").value)
      },
      mirror_rtu: {
        port: $("mir_port").value,
        baudrate: Number($("mir_baud").value),
        parity: $("mir_parity").value,
        stopbits: Number($("mir_stop").value),
        bytesize: Number($("mir_byte").value)
      },
      tcp: { port: Number($("tcp_port").value) },
      local_units: {
        unit0_id: Number($("u0").value),
        unit1_id: Number($("u1").value)
      },
      hr: { start: Number($("hr_start").value), count: Number($("hr_count").value) },
      branding: {
        phone: $("brand_phone").value,
        email: $("brand_email").value,
        youtube: $("brand_youtube").value,
        logo_url: $("brand_logo").value,
        qr_url: $("brand_qr").value
      },
      device: { model: $("device_model").value }
    };

    try{
      const r = await fetch("/api/settings", {
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const js = await r.json();

      if (js.ok) {
        await fillSettings();
        toast("Saved.");
        closeConfigModal();
      } else {
        toast(js.detail || "Save failed");
      }
    }catch(e){
      console.error(e);
      toast("Save failed");
    } finally {
      btn.disabled = false;
      btn.textContent = original;
    }
  };

  // Alarms
  async function renderAlarms(){
    try{
      const r = await fetch("/api/alarms");
      const js = await r.json();
      const root = document.getElementById("alarms");
      root.innerHTML = "";
      (js.alarms || []).forEach(a=>{
        const card = document.createElement("div");
        card.className = "alarm-pill";
        const t = document.createElement("div");
        t.className = "alarm-title";
        t.textContent = a.name;
        const v = document.createElement("div");
        v.className = "alarm-val " + (a.color === "red" ? "red" : "green");
        v.textContent = (a.on ? "ALARM" : "OK") + " ‚Äî " + (a.msg || "");
        card.appendChild(t);
        card.appendChild(v);
        root.appendChild(card);
      });
    }catch(e){}
  }
  setInterval(()=>{ tick(); renderAlarms(); }, 1000);
  renderAlarms();

  // Kick it off
  document.addEventListener("DOMContentLoaded", async ()=>{
    checkGate();
    if (localStorage.getItem("dash_gate_ok")==="1") {
      await fillSettings();
    }
  });
</script>
