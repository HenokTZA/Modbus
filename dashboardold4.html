<!doctype html><meta charset="utf-8">
<title>Modbus Mirror Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  /* ====== Base look & feel (kept from your original) ====== */
  body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;margin:0;background:#0b1220;color:#e8eefc}
  header{padding:12px 16px;border-bottom:1px solid #223;font-weight:600;display:flex;align-items:center;justify-content:space-between}
  main{padding:16px;display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:#111a2b;border:1px solid #223;border-radius:14px;padding:14px}
  .k{font-size:12px;color:#88a;text-transform:uppercase;letter-spacing:.1em}
  .v{font-size:28px;margin-top:6px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:6px 8px;border-bottom:1px solid #223;text-align:left}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{font-size:12px;color:#88a;padding:2px 8px;border:1px solid #223;border-radius:999px}
  .icon-btn{cursor:pointer;border:1px solid #223;background:#0f1830;color:#9fc3ff;border-radius:10px;padding:6px 10px}
  .icon-btn:hover{background:#13213d}
  a{color:#9fc3ff}

  /* ====== Modal ====== */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#0f1830;border:1px solid #223;border-radius:14px;width:min(820px,92vw);max-height:86vh;overflow:auto}
  .modal header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #223;padding:12px 16px}
  .modal .content{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  label{font-size:12px;color:#9ab}
  input,select{width:100%;padding:8px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
  .hint{font-size:12px;color:#8aa}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #223;background:#111a2b;color:#e8eefc;cursor:pointer}
  .btn.primary{background:#2956cc}
  .toast{position:fixed;bottom:16px;right:16px;background:#11213a;border:1px solid #2a3b66;padding:10px 12px;border-radius:10px;display:none;z-index:1200}

  /* ====== Top company strip ====== */
  .topbar{background:#bcd5e8;color:#073b5a}
  .topbar-inner{max-width:1400px;margin:0 auto;padding:8px 12px;display:grid;align-items:center;gap:8px;grid-template-columns:1fr auto auto}
  .top-left{display:flex;flex-direction:column;gap:6px;font-weight:600}
  .top-left a{color:#0a4f79;text-decoration:none}
  .top-center{display:flex;align-items:center;gap:12px}
  .qr{width:96px;height:96px;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .qr img{width:96px;height:96px;display:block}
  .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .logo{height:36px;object-fit:contain}
  .yt{color:#0a4f79;text-decoration:none;font-weight:700}
  .model-line{background:#a7c8de;font-weight:700;margin-top:6px;padding:6px 10px;border-radius:6px}
  .model-line span{color:#062e46}

  /* ====== NEW: Top cards row (Measurements / Alarms / Operating State) ====== */
  .top-row{grid-column:1/-1;display:grid;grid-template-columns:repeat(3,minmax(280px,1fr));gap:16px}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px 12px;align-items:center}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .pill2{padding:2px 8px;border-radius:999px;font-size:.85rem;display:inline-block;border:1px solid #223}
  .pill2.green{background:#10331a;color:#41d888}
  .pill2.red{background:#331314;color:#ff6b6b}
  .pill2.orange{background:#332610;color:#ffb454}
  .pill2.black{background:#1a1f2d;color:#e8eefc}

  /* ====== Legacy alarms area (hidden now) ====== */
  .alarm-wrap{display:none}

  /* ====== Full-screen PIN Gate ====== */
  .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1220,#0d1a33);display:flex;align-items:center;justify-content:center;z-index:2000}
  .gate-card{background:#0f1830;border:1px solid #223;border-radius:16px;padding:20px;width:min(420px,92vw);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .gate-title{font-size:18px;font-weight:700;margin-bottom:8px}
  .gate-sub{color:#9ab;font-size:13px;margin-bottom:12px}
  .gate-row{display:flex;gap:8px;align-items:center}
  .gate-input{flex:1;padding:10px;border-radius:10px;border:1px solid #294;outline:none;background:#0b1220;color:#e8eefc;font-size:16px}
  .gate-btn{padding:10px 14px;border-radius:10px;border:1px solid #223;background:#2956cc;color:#fff;cursor:pointer}
  .gate-err{color:#ff6b6b;font-size:13px;margin-top:8px;min-height:18px}

  /* ====== Settings PIN mini modal ====== */
  .pinbox{background:#0f1830;border:1px solid #223;border-radius:16px;padding:16px;width:min(360px,92vw)}
  .pin-title{font-weight:700;margin-bottom:6px}
  .pin-row{display:flex;gap:8px}
  .pin-input{flex:1;padding:10px;border-radius:10px;border:1px solid #223;background:#0b1220;color:#e8eefc}
  .pin-err{color:#ff6b6b;font-size:13px;margin-top:6px;min-height:18px}

  @media (max-width:1100px){ .top-row{grid-template-columns:1fr;}}
  @media (max-width: 640px){
    .topbar-inner{grid-template-columns:1fr;gap:12px}
    .top-right{align-items:flex-start}
  }
</style>

<!-- ====== Full-screen PIN Gate (client-side; update server if you add /api/login) ====== -->
<div id="gate" class="gate" style="display:none">
  <div class="gate-card">
    <div class="gate-title">Enter Access PIN</div>
    <div class="gate-sub">Please enter the 4-digit PIN to view the dashboard.</div>
    <div class="gate-row">
      <input id="gatePin" class="gate-input" type="password" placeholder="PIN" maxlength="8" inputmode="numeric" autofocus>
      <button id="gateBtn" class="gate-btn">Enter</button>
    </div>
    <div id="gateErr" class="gate-err"></div>
  </div>
</div>

<!-- ====== Top company strip ====== -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="top-left">
      <div>üìû <a id="phoneLink" href="#">011-4639-8310</a></div>
      <div>‚úâÔ∏è <a id="emailLink" href="#">info@adaxtecna.com</a></div>
    </div>
    <div class="top-center">
      <div class="qr"><img id="qrImg" alt="QR"></div>
    </div>
    <div class="top-right">
      <img id="logoImg" class="logo" alt="Logo" src="/static/adax_logo.png"/>
      <a id="ytLink" class="yt" href="#" target="_blank">Visit our YouTube channel</a>
      <div class="model-line">
        <span id="modelLine">RECTIFIER ADAX TECNA MODEL: CEA ‚Äî SERIAL NO: ‚Äî</span>
      </div>
    </div>
  </div>
</div>

<header>
  <div>Modbus Mirror ‚Ä¢ Live Dashboard</div>
  <button id="btnSettings" class="icon-btn" title="Settings">‚öôÔ∏è Settings</button>
</header>

<main>
  <!-- ====== NEW: Top cards row ====== -->
  <section class="top-row">
    <!-- Measurements -->
    <div class="card" id="cardMeas">
      <div class="k" style="letter-spacing:.08em">MEDICIONES ACTUALES</div>
      <div class="kv mono" id="measGrid" style="margin-top:8px"></div>
    </div>

    <!-- Alarms -->
    <div class="card" id="cardAlarms">
      <div class="k" style="letter-spacing:.08em">ALARMAS</div>
      <div id="alarmsList" style="margin-top:8px"></div>
    </div>

    <!-- Operating state -->
    <div class="card" id="cardStates">
      <div class="k" style="letter-spacing:.08em">ESTADO OPERATIVO</div>
      <div id="statesList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Status / quick links -->
  <section class="card" style="grid-column:1/-1">
    <div class="row">
      <div class="pill" id="m">mode: --</div>
      <div class="pill" id="t">last: --</div>
      <div class="pill"><a href="/api/hr" target="_blank">/api/hr</a></div>
      <div class="pill"><a href="/api/debug_store" target="_blank">/api/debug_store</a></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px">
      <div class="card"><div class="k">Battery Voltage</div><div class="v" id="vb">--</div></div>
      <div class="card"><div class="k">Load Voltage</div><div class="v" id="vl">--</div></div>
      <div class="card"><div class="k">Battery Current</div><div class="v" id="ib">--</div></div>
      <div class="card"><div class="k">Load Current</div><div class="v" id="il">--</div></div>
      <div class="card"><div class="k">Total Current</div><div class="v" id="it">--</div></div>
      <div class="card"><div class="k">Ambient Temp</div><div class="v" id="ta">--</div></div>
    </div>
  </section>

  <!-- Raw table -->
  <section class="card" style="grid-column:1/-1">
    <div class="k">Raw table (HR 0‚Äì23)</div>
    <table id="tbl"><thead><tr><th>Idx</th><th>Name</th><th>Raw</th><th>Scaled</th></tr></thead><tbody></tbody></table>
  </section>
</main>

<!-- ====== Settings PIN Modal (client-side) ====== -->
<div id="pinBackdrop" class="modal-backdrop">
  <div class="pinbox">
    <div class="pin-title">Enter Settings PIN</div>
    <div class="pin-row">
      <input id="settingsPin" class="pin-input" type="password" placeholder="PIN" maxlength="8" inputmode="numeric" autofocus>
      <button id="pinOk" class="btn primary">OK</button>
    </div>
    <div id="pinErr" class="pin-err"></div>
  </div>
</div>

<!-- ====== Settings Modal ====== -->
<div id="backdrop" class="modal-backdrop">
  <div class="modal">
    <header><div>Configuration</div><button id="btnClose" class="icon-btn">‚úñ</button></header>
    <div class="content">
      <p class="hint">All settings hot-reload. TCP & Mirror RTU restart automatically.</p>

      <h3>Upstream RTU (CH1)</h3>
      <div class="grid">
        <div><label>Port</label><input id="ups_port" placeholder="/dev/ttySC0"></div>
        <div><label>Baudrate</label><input id="ups_baud" type="number" placeholder="9600"></div>
        <div><label>Parity</label>
          <select id="ups_parity"><option>N</option><option>E</option><option>O</option></select>
        </div>
        <div><label>Stop Bits</label><input id="ups_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label>Byte Size</label><input id="ups_byte" type="number" placeholder="8" min="5" max="8"></div>
        <div><label>Device Unit ID</label><input id="ups_uid" type="number" placeholder="1" min="1" max="247"></div>
        <div><label>Poll Period (s)</label><input id="ups_poll" type="number" step="0.1" placeholder="1.0" min="0.1"></div>
      </div>

      <h3 style="margin-top:16px">Mirror RTU (CH2)</h3>
      <div class="grid">
        <div><label>Port</label><input id="mir_port" placeholder="/dev/ttySC1"></div>
        <div><label>Baudrate</label><input id="mir_baud" type="number" placeholder="9600"></div>
        <div><label>Parity</label>
          <select id="mir_parity"><option>N</option><option>E</option><option>O</option></select>
        </div>
        <div><label>Stop Bits</label><input id="mir_stop" type="number" placeholder="1" min="1" max="2"></div>
        <div><label>Byte Size</label><input id="mir_byte" type="number" placeholder="8" min="5" max="8"></div>
      </div>

      <h3 style="margin-top:16px">TCP Slave</h3>
      <div class="grid">
        <div><label>TCP Port</label><input id="tcp_port" type="number" placeholder="1502" min="1" max="65535"></div>
      </div>

      <h3 style="margin-top:16px">Branding & Device</h3>
      <div class="grid">
        <div><label>Phone</label><input id="brand_phone" placeholder="011-4639-8310"></div>
        <div><label>Email</label><input id="brand_email" placeholder="info@adaxtecna.com"></div>
        <div><label>YouTube URL</label><input id="brand_youtube" placeholder="https://www.youtube.com/@adaxtecna"></div>
        <div><label>Logo URL</label><input id="brand_logo" placeholder="/static/adax_logo.png"></div>
        <div><label>QR Image URL (optional)</label><input id="brand_qr" placeholder=""></div>
        <div><label>Model (e.g. CEA-24/20)</label><input id="device_model" placeholder="CEA-..."></div>
      </div>

      <h3 style="margin-top:16px">Local Unit IDs & HR Range</h3>
      <div class="grid">
        <div><label>Unit 0 (dashboard, 0-based)</label><input id="u0" type="number" min="1" max="247"></div>
        <div><label>Unit 1 (Modbus Poll, 1-based)</label><input id="u1" type="number" min="1" max="247"></div>
        <div><label>HR Start</label><input id="hr_start" type="number" min="0"></div>
        <div><label>HR Count</label><input id="hr_count" type="number" min="1"></div>
      </div>

      <div class="actions">
        <button class="btn" id="btnReload">Reload from Server</button>
        <button class="btn primary" id="btnSave">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  /* ====== Client-side constants (keep while server auth is optional) ====== */
  const ACCESS_PIN = "1234";
  const SETTINGS_PIN = "0000";

  const names = [
    "BATTERY_VOLTAGE_V","LOAD_VOLTAGE_V","BATTERY_CURRENT_A","LOAD_CURRENT_A","TOTAL_CURRENT_A",
    "AC_VOLTAGE_RN_raw","AC_VOLTAGE_SN_raw","AC_VOLTAGE_TN_raw",
    "AMBIENT_TEMP_C","AMBIENT_TEMP_MAX_C","ALARM_BYTE_1_bits","ALARM_BYTE_2_bits","BATTERY_MODE_raw",
    "BATTERY_TEST_COUNT","LAST_TEST_DURATION_H","LAST_TEST_DURATION_MIN","LAST_TEST_DAY","LAST_TEST_MONTH","LAST_TEST_YEAR",
    "LAST_TEST_FINAL_BATT_V","FLOAT_CURRENT_SETPOINT_PbCa_A","NUM_CELLS_NiCd","TIMER_HOURS_NiCd","SERIAL_NUMBER_raw"
  ];

  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 2200); };
  const F=(n,u)=>typeof n==="number"&&isFinite(n)?n.toFixed(1)+" "+(u||""):"--";

  /* ====== Access gate ====== */
  function showGate(){ $("gate").style.display="flex"; $("gatePin").focus(); }
  function hideGate(){ $("gate").style.display="none"; }
  function checkGate(){ if(localStorage.getItem("dash_gate_ok")==="1"){hideGate();return;} showGate(); }
  $("gateBtn").onclick=()=>{
    const val=$("gatePin").value.trim();
    if(val===ACCESS_PIN){ localStorage.setItem("dash_gate_ok","1"); hideGate(); }
    else{ $("gateErr").textContent="Incorrect PIN. Try again."; $("gatePin").value=""; $("gatePin").focus(); }
  };
  $("gatePin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("gateBtn").click(); });

  /* ====== Topbar from /api/settings ====== */
  function renderTopbarFromSettings(js){
    const b=js.branding||{}, d=js.device||{};
    const phone=b.phone||"", email=b.email||"", yt=b.youtube||"", logo=b.logo_url||"/static/adax_logo.png", qrUrl=b.qr_url||"", model=d.model||"CEA";
    $("phoneLink").textContent=phone; $("phoneLink").href=phone?("tel:"+phone.replace(/[^\d+]/g,'')):"#";
    $("emailLink").textContent=email; $("emailLink").href=email?("mailto:"+email):"#";
    if(logo){ $("logoImg").src=logo+(logo.includes("?")?"":"?v="+Date.now()); $("logoImg").style.display="block"; } else {$("logoImg").style.display="none";}
    if(yt) $("ytLink").href=yt; else $("ytLink").removeAttribute("href");
    const finalQR = qrUrl || (yt?("https://api.qrserver.com/v1/create-qr-code/?size=120x120&data="+encodeURIComponent(yt)):"");
    if(finalQR){ $("qrImg").src=finalQR; $("qrImg").style.display="block"; } else { $("qrImg").style.display="none"; }
    const base="RECTIFIER ADAX TECNA MODEL: "+model+" ‚Äî SERIAL NO: ";
    $("modelLine").textContent=base+"‚Äî"; $("modelLine").dataset.base=base;
  }

  /* ====== New top cards rendering ====== */
  function pill(text,color){ return `<span class="pill2 ${color}">${text}</span>`; }

  function renderMeasurements(m){
    const rows=[
      ["TENSI√ìN BATER√çA", `${(m.battery_voltage_v??0).toFixed(1)} Vcc`],
      ["TENSI√ìN CONSUMO", `${(m.load_voltage_v??0).toFixed(1)} Vcc`],
      ["CORRIENTE BATER√çA", `${(m.battery_current_a??0).toFixed(1)} A`],
      ["CORRIENTE CONSUMO", `${(m.load_current_a??0).toFixed(1)} A`],
      ["CORRIENTE TOTAL", `${(m.total_current_a??0).toFixed(1)} A`],
      ['TENSI√ìN C.A. "R-N"', `${m.ac_rn_v??0} Vca`],
      ['TENSI√ìN C.A. "S-N"', `${m.ac_sn_v??0} Vca`],
      ['TENSI√ìN C.A. "T-N"', `${m.ac_tn_v??0} Vca`],
      ["TEMPERATURA AMBIENTE", `${(m.ambient_temp_c??0).toFixed(1)} ¬∞C`],
      ["TEMP. M√ÅXIMA REGISTRADA", `${(m.ambient_temp_max_c??0).toFixed(1)} ¬∞C`],
    ];
    $("measGrid").innerHTML=rows.map(([k,v])=>`<div>${k}</div><div class="mono" style="font-weight:600">${v}</div>`).join("");
  }

  function renderAlarms2(items){
    $("alarmsList").innerHTML = items.map(it=>{
      const status = it.active ? pill("ACTIVA","red") : pill("NORMAL","green");
      return `<div class="kv"><div>${it.label}</div><div>${status}</div></div>`;
    }).join("");
  }

  function renderStates2(items){
    $("statesList").innerHTML = items.map(it=>{
      return `<div class="kv"><div>${it.label}</div><div>${pill(it.value,it.color)}</div></div>`;
    }).join("");
  }

  async function refreshTopCards(){
    // Try the dedicated endpoints first
    try{
      const [measR, alarmsR, statesR] = await Promise.all([
        fetch("/api/meas2"), fetch("/api/alarms2"), fetch("/api/states2")
      ]);

      if(measR.ok) renderMeasurements(await measR.json());
      if(alarmsR.ok){ const a = await alarmsR.json(); renderAlarms2(a.items||[]); }
      if(statesR.ok){ const s = await statesR.json(); renderStates2(s.items||[]); }

      if(measR.ok && alarmsR.ok && statesR.ok) return; // all good; skip fallback
    }catch(_){ /* fall back below */ }

    // Fallback to /api/hr if new endpoints not wired yet
    try{
      const r = await fetch("/api/hr"); if(!r.ok) return;
      const js = await r.json();
      const raw = js.raw||[], s = js.scaled||{};
      // Measurements fallback
      const m = {
        battery_voltage_v:(s.BATTERY_VOLTAGE_V??(raw[0]/10)),
        load_voltage_v:(s.LOAD_VOLTAGE_V??(raw[1]/10)),
        battery_current_a:(s.BATTERY_CURRENT_A??(raw[2]/10)),
        load_current_a:(s.LOAD_CURRENT_A??(raw[3]/10)),
        total_current_a:(s.TOTAL_CURRENT_A??(raw[4]/10)),
        ac_rn_v: raw[5], ac_sn_v: raw[6], ac_tn_v: raw[7],
        ambient_temp_c:(s.AMBIENT_TEMP_C??(raw[8]/10)),
        ambient_temp_max_c:(s.AMBIENT_TEMP_MAX_C??(raw[9]/10))
      };
      renderMeasurements(m);

      // Alarms fallback (bit mapping)
      const hr10 = raw[10]||0, hr11 = raw[11]||0;
      const bit=(v,n)=>((v>>n)&1)?1:0;
      renderAlarms2([
        {label:"POLO A TIERRA", active: bit(hr10,0)===1},
        {label:"ALTA TENSI√ìN BATER√çA", active: bit(hr10,1)===1},
        {label:"BAJA TENSI√ìN BATER√çA", active: bit(hr10,2)===1},
        {label:"INCOMUNICACI√ìN CONSUMO", active: bit(hr11,0)===1},
        {label:"RED C.A. ANORMAL", active: bit(hr11,3)===1},
        {label:"ALTA TENSI√ìN CONSUMO", active: bit(hr11,4)===1},
        {label:"BAJA TENSI√ìN CONSUMO", active: bit(hr11,5)===1},
        {label:"FUSIBLE ABIERTO", active: bit(hr11,7)===1},
        {label:"ALTA TEMPERATURA", active: bit(hr11,2)===1},
      ]);

      // Operating state fallback
      const hr12 = raw[12]||0;
      renderStates2([
        {label:"RECTIFICADOR", value: (bit(hr10,7)? "ENCENDIDO":"APAGADO"), color: (bit(hr10,7)? "green":"red")},
        {label:"BATER√çA EN", value: (hr12===1? "CARGA":"DESCARGA"), color: (hr12===1? "green":"red")},
        {label:"MODO DE CARGA", value: (bit(hr10,5)? "MANUAL":"AUTOM√ÅTICO"), color: (bit(hr10,5)? "orange":"green")},
        {label:"NIVEL DE CARGA", value: (bit(hr10,4)? "FONDO":"FLOTE"), color: "black"},
        {label:"TIMER NiCd", value: (bit(hr11,6)? "INICIADO":"DESACTIVADO"), color: "black"},
      ]);
    }catch(_){}
  }

  /* ====== Your existing tiles & table ====== */
  async function tickTiles(){
    try{
      const r=await fetch("/api/hr"); const js=await r.json();
      const s=js.scaled||{};
      $("vb").textContent=F(s.BATTERY_VOLTAGE_V,"V");
      $("vl").textContent=F(s.LOAD_VOLTAGE_V,"V");
      $("ib").textContent=F(s.BATTERY_CURRENT_A,"A");
      $("il").textContent=F(s.LOAD_CURRENT_A,"A");
      $("it").textContent=F(s.TOTAL_CURRENT_A,"A");
      $("ta").textContent=F(s.AMBIENT_TEMP_C,"¬∞C");
      $("m").textContent="mode: "+(js.mode||"--");
      $("t").textContent="last: "+new Date().toLocaleTimeString();

      const raw=js.raw||[];
      const serialRaw = (raw.length>23 ? raw[23] : "");
      const base = $("modelLine").dataset.base || "RECTIFIER ADAX TECNA MODEL: CEA ‚Äî SERIAL NO: ";
      $("modelLine").textContent = base + (serialRaw!=="" ? serialRaw : "‚Äî");

      const tb=document.querySelector("#tbl tbody"); tb.innerHTML="";
      names.forEach((nm,i)=>{
        const tr=document.createElement("tr");
        const td=(x)=>{const d=document.createElement("td"); d.textContent=x; return d;}
        tr.appendChild(td(i));
        tr.appendChild(td(nm));
        tr.appendChild(td(raw[i]??""));
        tr.appendChild(td(typeof s[nm]==="number"?s[nm]:""));
        tb.appendChild(tr);
      });
    }catch(e){}
  }

  /* ====== Settings modal & PIN (client-side) ====== */
  const openConfigModal = ()=>{ $("backdrop").style.display="flex"; };
  const closeConfigModal = ()=>{ $("backdrop").style.display="none"; };

  const openSettingsPin = ()=>{
    $("pinBackdrop").style.display="flex";
    $("settingsPin").value=""; $("pinErr").textContent="";
    setTimeout(()=>$("settingsPin").focus(), 10);
  };
  const closeSettingsPin = ()=>{ $("pinBackdrop").style.display="none"; };

  $("btnSettings").onclick = ()=>{ openSettingsPin(); };
  $("pinBackdrop").addEventListener("click",(e)=>{ if(e.target===$("pinBackdrop")) closeSettingsPin(); });
  $("pinOk").onclick = ()=>{
    if ($("settingsPin").value.trim() === SETTINGS_PIN) {
      closeSettingsPin(); openConfigModal();
    } else {
      $("pinErr").textContent = "Incorrect PIN. Try again.";
      $("settingsPin").value = ""; $("settingsPin").focus();
    }
  };
  $("settingsPin").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("pinOk").click(); });
  $("btnClose").onclick = closeConfigModal;
  $("backdrop").addEventListener("click",(e)=>{ if(e.target===$("backdrop")) closeConfigModal(); });

  async function fillSettings(){
    const r = await fetch("/api/settings"); const js = await r.json();
    renderTopbarFromSettings(js);
    const u=js.upstream, m=js.mirror_rtu, t=js.tcp, lu=js.local_units, hr=js.hr, b=js.branding||{}, d=js.device||{};
    $("ups_port").value=u.port; $("ups_baud").value=u.baudrate; $("ups_parity").value=u.parity;
    $("ups_stop").value=u.stopbits; $("ups_byte").value=u.bytesize; $("ups_uid").value=u.device_unit_id;
    $("ups_poll").value=u.poll_period_s;
    $("mir_port").value=m.port; $("mir_baud").value=m.baudrate; $("mir_parity").value=m.parity;
    $("mir_stop").value=m.stopbits; $("mir_byte").value=m.bytesize;
    $("tcp_port").value=t.port;
    $("brand_phone").value=b.phone||""; $("brand_email").value=b.email||"";
    $("brand_youtube").value=b.youtube||""; $("brand_logo").value=b.logo_url||"";
    $("brand_qr").value=b.qr_url||""; $("device_model").value=d.model||"";
    $("u0").value=lu.unit0_id; $("u1").value=lu.unit1_id;
    $("hr_start").value=hr.start; $("hr_count").value=hr.count;
  }
  $("btnReload").onclick = async ()=>{ await fillSettings(); toast("Settings reloaded"); };

  $("btnSave").onclick = async ()=>{
    const btn=$("btnSave"); btn.disabled=true; const original=btn.textContent; btn.textContent="Saving‚Ä¶";
    const payload = {
      upstream:{ port:$("ups_port").value, baudrate:+$("ups_baud").value, parity:$("ups_parity").value,
                 stopbits:+$("ups_stop").value, bytesize:+$("ups_byte").value, device_unit_id:+$("ups_uid").value,
                 poll_period_s:+$("ups_poll").value },
      mirror_rtu:{ port:$("mir_port").value, baudrate:+$("mir_baud").value, parity:$("mir_parity").value,
                   stopbits:+$("mir_stop").value, bytesize:+$("mir_byte").value },
      tcp:{ port:+$("tcp_port").value },
      local_units:{ unit0_id:+$("u0").value, unit1_id:+$("u1").value },
      hr:{ start:+$("hr_start").value, count:+$("hr_count").value },
      branding:{ phone:$("brand_phone").value, email:$("brand_email").value, youtube:$("brand_youtube").value,
                 logo_url:$("brand_logo").value, qr_url:$("brand_qr").value },
      device:{ model:$("device_model").value }
    };
    try{
      const r=await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      const js=await r.json();
      if(js.ok){ await fillSettings(); toast("Saved."); closeConfigModal(); }
      else{ toast(js.detail||"Save failed"); }
    }catch(e){ toast("Save failed"); }
    finally{ btn.disabled=false; btn.textContent=original; }
  };

  /* ====== Loops ====== */
  async function mainTick(){
    await Promise.all([tickTiles(), refreshTopCards()]);
    setTimeout(mainTick, 1000);
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    checkGate();
    if (localStorage.getItem("dash_gate_ok")==="1") { await fillSettings(); }
    mainTick();
  });
</script>
